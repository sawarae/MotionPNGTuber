# é¡”ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è§£èª¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

`face_track_anime_detector.py` ã¯ã€anime-face-detectorã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å£ã®ä½ç½®ã‚’å‹•ç”»å…¨ä½“ã§ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [æŠ€è¡“çš„ç‰¹å¾´](#æŠ€è¡“çš„ç‰¹å¾´)
3. [ä½¿ã„æ–¹](#ä½¿ã„æ–¹)
4. [ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°](#ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°)
5. [ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è§£èª¬](#ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è§£èª¬)
6. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### ç›®çš„

å‹•ç”»å†…ã®ã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®**å£ã®ä½ç½®ãƒ»ã‚µã‚¤ã‚ºãƒ»è§’åº¦**ã‚’å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¿½è·¡ã—ã€`.npz`ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ã“ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯ã€å£æ¶ˆã—å‡¦ç†ï¼ˆ[erase_mouth_offline.py](mouth-eraser-tools.md)ï¼‰ã‚„ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å£ãƒ‘ã‚¯å‡¦ç†ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

### å¾“æ¥æ‰‹æ³•ã¨ã®é•ã„

| ç‰¹å¾´ | anime-face-detectoræ–¹å¼ | ORBãƒ™ãƒ¼ã‚¹æ–¹å¼ |
|-----|------------------------|-------------|
| æ¤œå‡ºæ–¹æ³• | ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ç‹¬ç«‹ã—ã¦æ¤œå‡º | æœ€åˆã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åŸºæº–ã«è¿½è·¡ |
| é«˜é€Ÿãªå‹•ã | âœ… å¼·ã„ | âŒ å¼±ã„ï¼ˆãƒ­ã‚¹ãƒˆã—ã‚„ã™ã„ï¼‰ |
| å‡¦ç†é€Ÿåº¦ | ã‚„ã‚„é…ã„ï¼ˆæ·±å±¤å­¦ç¿’ï¼‰ | é€Ÿã„ |
| ç²¾åº¦ | é«˜ã„ | ä¸­ç¨‹åº¦ |
| ä¾å­˜é–¢ä¿‚ | mmcv, mmdet, mmpose | OpenCV ã®ã¿ |

### å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«

**mouth_track.npz** (NumPyåœ§ç¸®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–)

```python
{
    'quad': (N, 4, 2) float32,      # å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®å£é ˜åŸŸã®4ç‚¹åº§æ¨™
    'valid': (N,) uint8,             # å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§æ¤œå‡ºæˆåŠŸã—ãŸã‹ (0/1)
    'confidence': (N,) float32,      # æ¤œå‡ºä¿¡é ¼åº¦
    'fps': float,                    # å‹•ç”»ã®FPS
    'w': int, 'h': int,              # å‹•ç”»ã®è§£åƒåº¦
    'ref_sprite_w': int,             # å‚ç…§ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆå¹…
    'ref_sprite_h': int,             # å‚ç…§ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé«˜ã•
    'pad': float,                    # ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ä¿‚æ•°
    'det_scale': float,              # æ¤œå‡ºæ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«
    'det_stride': int                # æ¤œå‡ºã‚¹ãƒˆãƒ©ã‚¤ãƒ‰
}
```

**quadåº§æ¨™ã®å®šç¾©:**
```
quad[i] = [
    [TL_x, TL_y],    # Top-Left (å·¦ä¸Š)
    [TR_x, TR_y],    # Top-Right (å³ä¸Š)
    [BR_x, BR_y],    # Bottom-Right (å³ä¸‹)
    [BL_x, BL_y]     # Bottom-Left (å·¦ä¸‹)
]
```

---

## æŠ€è¡“çš„ç‰¹å¾´

### 1. **anime-face-detector ã«ã‚ˆã‚‹é«˜ç²¾åº¦æ¤œå‡º**

```
[å…¥åŠ›ãƒ•ãƒ¬ãƒ¼ãƒ ]
     â†“
[YOLOv3ãƒ™ãƒ¼ã‚¹ã®é¡”æ¤œå‡º]
     â†“
[28ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ¤œå‡º]  â† MMPoseãƒ™ãƒ¼ã‚¹
     â†“
[å£é ˜åŸŸã®4ç‚¹(quad)æ¨å®š]
```

#### 28ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯

```
ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
- 0-10:  é¡”è¼ªéƒ­
- 11-16: å·¦ç›® (6ç‚¹)
- 17-22: å³ç›® (6ç‚¹)
- 23:    é¼»
- 24-27: å£ (4ç‚¹) â† ã“ã‚Œã‚’ä½¿ç”¨ï¼
```

### 2. **3ã¤ã®quadç”Ÿæˆãƒ¢ãƒ¼ãƒ‰**

#### ãƒ¢ãƒ¼ãƒ‰æ¯”è¼ƒè¡¨

| ãƒ¢ãƒ¼ãƒ‰ | åŸºæº– | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | æ¨å¥¨ç”¨é€” |
|-------|-----|---------|----------|---------|
| `hybrid` | å£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ + æœ€å°ã‚µã‚¤ã‚ºä¿è¨¼ | ãƒãƒ©ãƒ³ã‚¹â— | - | **æ¨å¥¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰** |
| `mouth` | å£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ã¿ | å£ã®å½¢çŠ¶ã«å¿ å®Ÿ | é–‰ã˜ãŸå£ã§å°ã•ããªã‚Šã™ãã‚‹ | å¸¸ã«å£ãŒé–‹ã„ã¦ã„ã‚‹å‹•ç”» |
| `bbox` | é¡”å…¨ä½“ã®ã‚µã‚¤ã‚º | å®‰å®šã—ãŸã‚µã‚¤ã‚º | å£ã®å®Ÿéš›ã®å¤§ãã•ã‚’ç„¡è¦– | å¾“æ¥ã®äº’æ›æ€§ |

#### hybrid ãƒ¢ãƒ¼ãƒ‰ã®å‹•ä½œ

```python
# ã‚¹ãƒ†ãƒƒãƒ—1: å£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
w_landmark = å£ã®4ç‚¹ã®æ¨ªå¹…
h_landmark = å£ã®4ç‚¹ã®ç¸¦å¹…

# ã‚¹ãƒ†ãƒƒãƒ—2: æœ€å°ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
w_floor_ratio = é¡”å¹… * min_mouth_w_ratio (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.12)
w_floor_px = min_mouth_w_px (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 16.0)

# ã‚¹ãƒ†ãƒƒãƒ—3: æœ€å¤§å€¤ã‚’æ¡ç”¨
w = max(w_landmark, w_floor_ratio, w_floor_px)

# ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è€ƒæ…®ã—ã¦é«˜ã•ã‚’æ±ºå®š
h = max(h_landmark, w / sprite_aspect)

# ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’é©ç”¨
final_w = w * pad  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2.1å€
final_h = h * pad
```

**ãªãœhybridãŒæ¨å¥¨ã‹ï¼Ÿ**
- å£ãŒé–‹ã„ã¦ã„ã‚‹ã¨ã: ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã«å¿ å®Ÿ â†’ æ­£ç¢º
- å£ãŒé–‰ã˜ã¦ã„ã‚‹ã¨ã: æœ€å°ã‚µã‚¤ã‚ºã‚’ä¿è¨¼ â†’ å°ã•ã™ããªã„
- é¡”ã®å‚¾ãã«ã‚‚å¯¾å¿œ: ç›®ã®å‚¾ãã‹ã‚‰å›è»¢è§’åº¦ã‚’æ¨å®š

### 3. **Zero-Phase EMAã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°**

#### å•é¡Œ: ç”Ÿã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã¯ä¸å®‰å®š

```
ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã®å¾®å°ãªæ¤œå‡ºèª¤å·®:
  Frame 1: quad center = (100.2, 200.1)
  Frame 2: quad center = (100.8, 199.7)  â† 0.6px ãšã‚Œ
  Frame 3: quad center = (99.9, 200.3)   â† 0.9px ãšã‚Œ
â†’ çµæœ: ã‚«ã‚¯ã‚«ã‚¯ã—ã¦è¦‹ãˆã‚‹
```

#### è§£æ±º: Zero-Phase EMA (åŒæ–¹å‘ãƒ•ã‚£ãƒ«ã‚¿)

```python
# é€šå¸¸ã®EMA (å› æœãƒ•ã‚£ãƒ«ã‚¿)
def forward_ema(data, beta):
    for i in range(1, len(data)):
        data[i] = data[i-1] + beta * (data[i] - data[i-1])
    return data

# Zero-Phase EMA (éå› æœãƒ•ã‚£ãƒ«ã‚¿)
def zero_phase_ema(data, beta):
    # é †æ–¹å‘
    forward = forward_ema(data.copy(), beta)
    # é€†æ–¹å‘
    backward = forward_ema(forward[::-1].copy(), beta)[::-1]
    return backward
```

**åŠ¹æœ:**
- **ä½ç›¸é…ã‚Œãªã—**: é€šå¸¸ã®EMAã¨é•ã„ã€æ™‚é–“çš„ãªé…å»¶ãŒç™ºç”Ÿã—ãªã„
- **æ»‘ã‚‰ã‹ã•å‘ä¸Š**: é †æ–¹å‘+é€†æ–¹å‘ã§2å›ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- **ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•°**: `--smooth-cutoff` ã§èª¿æ•´å¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3.0 Hzï¼‰

#### betaä¿‚æ•°ã®è¨ˆç®—

```python
beta = 1.0 - exp(-2Ï€ * cutoff_hz / fps)

ä¾‹:
- cutoff_hz = 3.0, fps = 30
  â†’ beta â‰ˆ 0.53

- cutoff_hz = 5.0, fps = 30
  â†’ beta â‰ˆ 0.71  (ã‚ˆã‚Šè¿½å¾“æ€§ãŒé«˜ã„)

- cutoff_hz = 1.0, fps = 30
  â†’ beta â‰ˆ 0.20  (ã‚ˆã‚Šæ»‘ã‚‰ã‹)
```

### 4. **è§’åº¦ã®ç‰¹æ®Šå‡¦ç†**

#### å•é¡Œ: è§’åº¦ã®ãƒ©ãƒƒãƒ—ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰

```
Frame N:   angle = 175Â°
Frame N+1: angle = -178Â°  â† å®Ÿéš›ã¯3Â°ã—ã‹å¤‰ã‚ã£ã¦ã„ãªã„
â†’ å˜ç´”ã«ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã™ã‚‹ã¨: å¹³å‡ â‰ˆ -1.5Â° (å¤§ããè·³ã­ã‚‹ï¼)
```

#### è§£æ±ºç­–

```python
# 1. unwrap: -180ã€œ180Â°ã®ã‚¸ãƒ£ãƒ³ãƒ—ã‚’é€£ç¶šå€¤ã«å¤‰æ›
angles_rad = np.radians(angles)
angles_unwrapped = np.unwrap(angles_rad)  # 175Â°, 182Â° ã«å¤‰æ›
angles_deg = np.degrees(angles_unwrapped)

# 2. ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿: 1-2ãƒ•ãƒ¬ãƒ¼ãƒ ã®å¤–ã‚Œå€¤ã‚’é™¤å»
angles_filtered = median_filter(angles_deg, kernel_size=3)

# 3. EMAã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
angles_smooth = zero_phase_ema(angles_filtered, beta)

# 4. è§’åº¦å¤‰åŒ–ã®åˆ¶é™ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
max_change = 15.0  # åº¦/ãƒ•ãƒ¬ãƒ¼ãƒ 
for i in range(1, len(angles_smooth)):
    diff = angles_smooth[i] - angles_smooth[i-1]
    if abs(diff) > max_change:
        angles_smooth[i] = angles_smooth[i-1] + sign(diff) * max_change
```

### 5. **InvalidåŒºé–“ã®è£œé–“**

#### ç·šå½¢è£œé–“ (center, width, height, angle)

```python
# å•é¡Œ: å˜ç´”ãªã‚³ãƒ¼ãƒŠãƒ¼åº§æ¨™ã®ç·šå½¢è£œé–“ã¯æ­ªã¿ã‚„ã™ã„
# æ‚ªã„ä¾‹:
quad_interpolated = (1-t) * quad[prev] + t * quad[next]
â†’ å›è»¢ã‚’å«ã‚€å ´åˆã«å››è§’å½¢ãŒæ­ªã‚€

# è‰¯ã„ä¾‹: ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯è£œé–“
center, width, height, angle = decompose(quad[prev])
center_next, width_next, height_next, angle_next = decompose(quad[next])

# è§’åº¦ã¯æœ€çŸ­çµŒè·¯ã§è£œé–“
angle_diff = (angle_next - angle + 180) % 360 - 180

# å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç‹¬ç«‹ã«è£œé–“
center_interp = (1-t) * center + t * center_next
width_interp = (1-t) * width + t * width_next
height_interp = (1-t) * height + t * height_next
angle_interp = angle + t * angle_diff

# å†æ§‹æˆ
quad_interpolated = compose(center_interp, width_interp, height_interp, angle_interp)
```

### 6. **æ¤œå‡ºã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã«ã‚ˆã‚‹é«˜é€ŸåŒ–**

```python
# é…ã„æ–¹æ³•: ãƒ«ãƒ¼ãƒ—
for i in range(N):
    center, w, h, angle = decompose_quad(quads[i])
    # ... å‡¦ç† ...
    quads[i] = compose_quad(center, w, h, angle)

# é«˜é€Ÿãªæ–¹æ³•: ãƒ™ã‚¯ãƒˆãƒ«åŒ–
centers, widths, heights, angles = decompose_quads_vectorized(quads)  # å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ä¸€æ‹¬
# ... NumPyé…åˆ—æ¼”ç®— ...
quads = compose_quads_vectorized(centers, widths, heights, angles)

é€Ÿåº¦æ”¹å–„: ç´„5ã€œ10å€
```

---

## ä½¿ã„æ–¹

### åŸºæœ¬çš„ãªä½¿ç”¨æ³•

```bash
uv run python face_track_anime_detector.py \
    --video "loop.mp4" \
    --out "mouth_track.npz" \
    --debug "mouth_track_debug.mp4"
```

### å“è³ªãƒ—ãƒªã‚»ãƒƒãƒˆ

```bash
# æœ€é«˜å“è³ª (å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã€å…ƒè§£åƒåº¦)
--quality max

# é«˜å“è³ª (å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã€0.75å€è§£åƒåº¦)
--quality high

# æ¨™æº–å“è³ª (2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã€0.5å€è§£åƒåº¦) â† ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½
--quality normal

# é«˜é€Ÿ (3ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã€0.5å€è§£åƒåº¦)
--quality fast

# ã‚«ã‚¹ã‚¿ãƒ  (è‡ªåˆ†ã§è¨­å®š)
--quality custom --det-scale 0.8 --stride 2
```

### æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```bash
# ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšnormalã§è©¦ã™
uv run python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality normal \
    --debug mouth_track_debug.mp4

# ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒãƒƒã‚°å‹•ç”»ã§ç¢ºèª
# mouth_track_debug.mp4 ã‚’å†ç”Ÿã—ã¦ã€å£quadãŒæ­£ã—ããƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

# ã‚¹ãƒ†ãƒƒãƒ—3: å•é¡ŒãŒã‚ã‚Œã°å“è³ªã‚’ä¸Šã’ã‚‹
--quality high  # ã¾ãŸã¯ max

# ã‚¹ãƒ†ãƒƒãƒ—4: valid_rateãŒä½ã‘ã‚Œã°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
--min-conf 0.3  # ä¿¡é ¼åº¦ã®é–¾å€¤ã‚’ä¸‹ã’ã‚‹
--det-scale 1.0  # æ¤œå‡ºè§£åƒåº¦ã‚’ä¸Šã’ã‚‹
```

---

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°

### å…¥å‡ºåŠ›

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ä¾‹ |
|-----------|------|---|
| `--video` | å…¥åŠ›å‹•ç”» | loop.mp4 |
| `--out` | å‡ºåŠ›ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ« | mouth_track.npz |
| `--debug` | ãƒ‡ãƒãƒƒã‚°å‹•ç”»ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | mouth_track_debug.mp4 |

### å“è³ªè¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `--quality` | å“è³ªãƒ—ãƒªã‚»ãƒƒãƒˆ | custom | max, high, normal, fast, custom |
| `--det-scale` | æ¤œå‡ºæ™‚ã®è§£åƒåº¦å€ç‡ | 1.0 | 0.25 ~ 1.5 |
| `--stride` | N ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«æ¤œå‡º | 1 | 1 ~ 10 |

**det-scale ã®å½±éŸ¿:**
```
det-scale=1.0: 1920x1080 â†’ 1920x1080 (å…ƒã®ã¾ã¾)
det-scale=0.75: 1920x1080 â†’ 1440x810
det-scale=0.5: 1920x1080 â†’ 960x540

é«˜ã„: ç²¾åº¦â†‘ é€Ÿåº¦â†“
ä½ã„: ç²¾åº¦â†“ é€Ÿåº¦â†‘
```

**stride ã®å½±éŸ¿:**
```
stride=1: å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã§æ¤œå‡º (æœ€é«˜ç²¾åº¦)
stride=2: 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«æ¤œå‡ºã€é–“ã‚’è£œé–“
stride=3: 3ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«æ¤œå‡ºã€é–“ã‚’è£œé–“

ä½ã„: ç²¾åº¦â†‘ é€Ÿåº¦â†“
é«˜ã„: ç²¾åº¦â†“ é€Ÿåº¦â†‘ (ãŸã ã—é«˜é€Ÿãªå‹•ãã«å¼±ã„)
```

### quadç”Ÿæˆè¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `--quad-mode` | quadç”Ÿæˆæ–¹å¼ | hybrid | hybrid, mouth, bbox |
| `--pad` | ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ä¿‚æ•° | 2.1 | 1.0 ~ 3.0 |
| `--sprite-aspect` | ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” (w/h) | 1.0 | 0.7 ~ 3.0 |
| `--min-mouth-w-ratio` | æœ€å°å£å¹…ï¼ˆé¡”å¹…æ¯”ï¼‰ | 0.12 | 0.0 ~ 0.40 |
| `--min-mouth-w-px` | æœ€å°å£å¹…ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ | 16.0 | 0.0 ~ 64.0 |

**pad ã®å½¹å‰²:**
```
pad=1.0: å£ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã´ã£ãŸã‚Š
pad=2.0: 2å€ã®å¤§ãã• (ä½™è£•ã‚’æŒãŸã›ã‚‹)
pad=2.1: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (æ¨å¥¨)

å°ã•ã„: å£æ¶ˆã—æ™‚ã«å£ãŒå®Œå…¨ã«æ¶ˆãˆãªã„å¯èƒ½æ€§
å¤§ãã„: é¼»ã‚„é ¬ã¾ã§æ¶ˆã—ã¦ã—ã¾ã†å¯èƒ½æ€§
```

### æ¤œå‡ºè¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `--model` | æ¤œå‡ºãƒ¢ãƒ‡ãƒ« | yolov3 | yolov3 |
| `--device` | å®Ÿè¡Œãƒ‡ãƒã‚¤ã‚¹ | cuda:0 | cpu, cuda:N, auto |
| `--min-conf` | æœ€å°æ¤œå‡ºä¿¡é ¼åº¦ | 0.5 | 0.0 ~ 0.99 |

**min-conf ã®èª¿æ•´:**
```
é«˜ã„ (0.7~0.9): ç¢ºå®Ÿã«é¡”ã¨åˆ¤å®šã§ãã‚‹ã‚‚ã®ã®ã¿
â†“ ãƒ¡ãƒªãƒƒãƒˆ: èª¤æ¤œå‡ºãŒå°‘ãªã„
â†“ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: æ¤œå‡ºç‡ãŒä¸‹ãŒã‚‹ (valid_rateä½ä¸‹)

ä½ã„ (0.3~0.5): æ€ªã—ã„ã‚‚ã®ã‚‚å«ã‚ã‚‹
â†“ ãƒ¡ãƒªãƒƒãƒˆ: æ¤œå‡ºç‡ãŒä¸ŠãŒã‚‹
â†“ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: èª¤æ¤œå‡ºã®å¯èƒ½æ€§

æ¨å¥¨: 0.5 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
valid_rateãŒä½ã„å ´åˆ: 0.3 ã«ä¸‹ã’ã¦ã¿ã‚‹
```

### ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `--smooth-cutoff` | ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•° (Hz) | 3.0 | 0.0 ~ 10.0 |
| `--max-angle-change` | æœ€å¤§è§’åº¦å¤‰åŒ– (åº¦/ãƒ•ãƒ¬ãƒ¼ãƒ ) | 15.0 | 0.0 ~ 360.0 |
| `--valid-min-ratio` | ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã®æœ€å°validç‡ | 0.05 | 0.0 ~ 1.0 |
| `--valid-min-count` | ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã®æœ€å°validæ•° | 5 | 0 ~ 1000 |

**smooth-cutoff ã®é¸ã³æ–¹:**
```
å¤§ãã„ (5.0~10.0): ã‚ˆã‚Šè¿½å¾“æ€§ãŒé«˜ã„ã€ã‚«ã‚¯ã‚«ã‚¯æ®‹ã‚‹
â†“ ç”¨é€”: æ¿€ã—ã„å‹•ãã®ã‚ã‚‹å‹•ç”»

ä¸­é–“ (3.0~4.0): ãƒãƒ©ãƒ³ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
â†“ ç”¨é€”: ä¸€èˆ¬çš„ãªå‹•ç”»

å°ã•ã„ (1.0~2.0): ã‚ˆã‚Šæ»‘ã‚‰ã‹ã€é…å»¶ãŒç›®ç«‹ã¤
â†“ ç”¨é€”: ã‚†ã£ãã‚Šã—ãŸå‹•ã

0.0: ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹
```

**max-angle-change ã®å½¹å‰²:**
```
å•é¡Œ: æ¤œå‡ºã‚¨ãƒ©ãƒ¼ã§çªç„¶90Â°å›è»¢ã—ã¦ã—ã¾ã†

è§£æ±º: 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šã®è§’åº¦å¤‰åŒ–ã‚’åˆ¶é™
15.0 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ): 1ãƒ•ãƒ¬ãƒ¼ãƒ ã§æœ€å¤§15Â°ã¾ã§
â†’ æ€¥æ¿€ãªå›è»¢ã‚’æŠ‘åˆ¶

0.0: åˆ¶é™ãªã—
```

### äº’æ›æ€§è¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|-----------|------|----------|
| `--ref-sprite-w` | å‚ç…§ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆå¹… | 128 |
| `--ref-sprite-h` | å‚ç…§ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆé«˜ã• | 85 |

ã“ã‚Œã‚‰ã¯ä¸»ã«å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã®äº’æ›æ€§ã®ãŸã‚ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

---

## ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è§£èª¬

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‹•ç”»å…¥åŠ›       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚stride?â”‚ YES â†’ æ¤œå‡ºã‚¹ã‚­ãƒƒãƒ—ã€å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        NO
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ det_scaleã§     â”‚
â”‚ ãƒªã‚µã‚¤ã‚º        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ anime-face-     â”‚
â”‚ detectorå®Ÿè¡Œ    â”‚ â†’ bbox + 28ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€å¤§é¢ç©ã®é¡”ã‚’  â”‚
â”‚ é¸æŠ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ä¿¡é ¼åº¦  â”‚ NO â†’ valid[i]=0ã€å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¿æŒ
    â”‚>=min?  â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       YES
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ quadç”Ÿæˆ        â”‚
â”‚ (modeæŒ‡å®š)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ quad[i]ã«ä¿å­˜   â”‚
â”‚ valid[i]=1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å…¨ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†å®Œäº†
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ InvalidåŒºé–“ã‚’   â”‚
â”‚ ç·šå½¢è£œé–“        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Zero-Phase EMA  â”‚
â”‚ ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .npzä¿å­˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Quadåˆ†è§£ãƒ»å†æ§‹æˆã®æ•°å­¦

#### åˆ†è§£ (Decomposition)

```python
def decompose_quad(quad):
    # quad: [TL, TR, BR, BL]  (4, 2)

    # 1. ä¸­å¿ƒåº§æ¨™
    center = quad.mean(axis=0)

    # 2. å¹… (TLâ†’TR ã®ãƒãƒ«ãƒ )
    v_top = quad[1] - quad[0]  # TR - TL
    width = ||v_top||

    # 3. é«˜ã• (TLâ†’BL ã®ãƒãƒ«ãƒ )
    v_left = quad[3] - quad[0]  # BL - TL
    height = ||v_left||

    # 4. è§’åº¦ (TLâ†’TR ã®è§’åº¦)
    angle = atan2(v_top[1], v_top[0])

    return center, width, height, angle
```

#### å†æ§‹æˆ (Composition)

```python
def compose_quad(center, width, height, angle):
    # 1. ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»ã§quadã‚’å®šç¾©
    hw, hh = width/2, height/2
    local = [
        [-hw, -hh],  # TL
        [+hw, -hh],  # TR
        [+hw, +hh],  # BR
        [-hw, +hh]   # BL
    ]

    # 2. å›è»¢è¡Œåˆ—ã‚’ä½œæˆ
    R = [[cos(angle), -sin(angle)],
         [sin(angle),  cos(angle)]]

    # 3. å›è»¢ã‚’é©ç”¨
    rotated = local @ R.T

    # 4. ä¸­å¿ƒã«å¹³è¡Œç§»å‹•
    quad = rotated + center

    return quad
```

**ãªãœã“ã®æ–¹å¼ï¼Ÿ**
- å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç‹¬ç«‹
- è£œé–“ãŒç°¡å˜ï¼ˆç·šå½¢è£œé–“ã§OKï¼‰
- è§’åº¦ã®æ‰±ã„ãŒæ˜ç¤ºçš„
- ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã‚„ã™ã„

### é¡”ã®å‚¾ãæ¨å®š

```python
def estimate_face_rotation(keypoints):
    # 28ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‹ã‚‰ç›®ã®ä½ç½®ã‚’æŠ½å‡º
    left_eye_center = keypoints[11:17].mean(axis=0)   # å·¦ç›®6ç‚¹ã®ä¸­å¿ƒ
    right_eye_center = keypoints[17:23].mean(axis=0)  # å³ç›®6ç‚¹ã®ä¸­å¿ƒ

    # ä¸¡ç›®ã‚’çµã¶ç·šã®è§’åº¦
    dx = right_eye_center[0] - left_eye_center[0]
    dy = right_eye_center[1] - left_eye_center[1]
    angle = atan2(dy, dx)

    return degrees(angle)
```

**ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«:**
```
æ­£é¢ã‚’å‘ã„ã¦ã„ã‚‹:
  å·¦ç›® â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â— å³ç›®
       (angle â‰ˆ 0Â°)

å³ã«å‚¾ã„ã¦ã„ã‚‹:
      â—
     /  å·¦ç›®
    /
   â— å³ç›®
   (angle â‰ˆ -20Â°)

å·¦ã«å‚¾ã„ã¦ã„ã‚‹:
        â— å³ç›®
         \
          \
           â— å·¦ç›®
   (angle â‰ˆ +20Â°)
```

### ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ (å¤–ã‚Œå€¤é™¤å»)

```python
def median_filter_1d(arr, kernel_size=3):
    # å„ç‚¹ã®è¿‘å‚ (å‰å¾ŒÂ±1) ã®ä¸­å¤®å€¤ã‚’æ¡ç”¨

    ä¾‹:
    å…¥åŠ›: [10, 11, 50, 12, 13]  â† 50ãŒå¤–ã‚Œå€¤
           â†“
    kernel_size=3 ã§å‡¦ç†:
    [10, 11, 50, 12, 13]
         â†“
    i=0: median([10, 11]) = 10.5
    i=1: median([10, 11, 50]) = 11  â† å¤–ã‚Œå€¤ã®å½±éŸ¿å°
    i=2: median([11, 50, 12]) = 12  â† è£œæ­£ã•ã‚Œã‚‹ï¼
    i=3: median([50, 12, 13]) = 12
    i=4: median([12, 13]) = 12.5
           â†“
    å‡ºåŠ›: [10.5, 11, 12, 12, 12.5]  â† æ»‘ã‚‰ã‹
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: valid_rate ãŒä½ã„ï¼ˆ< 80%ï¼‰

**ç—‡çŠ¶:**
```
[warn] tracking quality low: valid_rate=0.42.
       Try det-scaleâ†‘ or strideâ†“ (or min-confâ†“) for this video.
```

**åŸå› :**
- é¡”ãŒå°ã•ã™ãã¦æ¤œå‡ºã§ããªã„
- ç”»è³ªãŒä½ã„
- å‹•ããŒé€Ÿã™ãã‚‹ï¼ˆstrideä½¿ç”¨æ™‚ï¼‰
- ä¿¡é ¼åº¦ã®é–¾å€¤ãŒé«˜ã™ãã‚‹

**å¯¾å‡¦æ³•:**

```bash
# 1. æ¤œå‡ºè§£åƒåº¦ã‚’ä¸Šã’ã‚‹
--det-scale 1.0  # ã¾ãŸã¯ 0.75 â†’ 1.0

# 2. ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’æ¸›ã‚‰ã™ï¼ˆå…¨ãƒ•ãƒ¬ãƒ¼ãƒ æ¤œå‡ºï¼‰
--stride 1

# 3. ä¿¡é ¼åº¦ã®é–¾å€¤ã‚’ä¸‹ã’ã‚‹
--min-conf 0.3  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.5

# 4. å“è³ªãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¸Šã’ã‚‹
--quality high  # ã¾ãŸã¯ max
```

### å•é¡Œ2: quad ãŒã‚«ã‚¯ã‚«ã‚¯ã™ã‚‹

**ç—‡çŠ¶:**
ãƒ‡ãƒãƒƒã‚°å‹•ç”»ã§å£ã®quadãŒå°åˆ»ã¿ã«æºã‚Œã‚‹

**åŸå› :**
- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ãŒå¼±ã„
- æ¤œå‡ºè‡ªä½“ãŒä¸å®‰å®š

**å¯¾å‡¦æ³•:**

```bash
# 1. ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•°ã‚’ä¸‹ã’ã‚‹ï¼ˆã‚ˆã‚Šæ»‘ã‚‰ã‹ã«ï¼‰
--smooth-cutoff 2.0  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3.0

# 2. è§’åº¦å¤‰åŒ–ã‚’åˆ¶é™
--max-angle-change 10.0  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15.0

# 3. æ¤œå‡ºå“è³ªã‚’ä¸Šã’ã‚‹
--det-scale 1.0
--min-conf 0.6
```

### å•é¡Œ3: quad ã®ã‚µã‚¤ã‚ºãŒä¸å®‰å®š

**ç—‡çŠ¶:**
ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã§quadã®å¤§ãã•ãŒå¤§ããå¤‰ã‚ã‚‹

**åŸå› :**
- `mouth` ãƒ¢ãƒ¼ãƒ‰ã§å£ã®é–‹é–‰ã«ã‚ˆã‚Šã‚µã‚¤ã‚ºãŒå¤‰å‹•
- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã®valid_rateãŒä½ã™ãã¦ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ

**å¯¾å‡¦æ³•:**

```bash
# 1. hybridãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ï¼ˆã‚µã‚¤ã‚ºã®ä¸‹é™ã‚’ä¿è¨¼ï¼‰
--quad-mode hybrid

# 2. æœ€å°ã‚µã‚¤ã‚ºã‚’èª¿æ•´
--min-mouth-w-ratio 0.15  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.12
--min-mouth-w-px 20.0     # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 16.0

# 3. æ¤œå‡ºç‡ã‚’æ”¹å–„ã—ã¦ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
--det-scale 1.0
--min-conf 0.4
```

### å•é¡Œ4: å£ãŒå°ã•ã™ãã‚‹

**ç—‡çŠ¶:**
quadãŒå£ã‚ˆã‚Šã‚‚å°ã•ãã€å£ã®ç«¯ãŒéš ã‚Œãªã„

**åŸå› :**
- `pad` ãŒå°ã•ã™ãã‚‹
- `mouth` ãƒ¢ãƒ¼ãƒ‰ã§é–‰ã˜ãŸå£ã‚’æ¤œå‡º

**å¯¾å‡¦æ³•:**

```bash
# 1. ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™
--pad 2.5  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2.1

# 2. hybridãƒ¢ãƒ¼ãƒ‰ã§æœ€å°ã‚µã‚¤ã‚ºã‚’ä¿è¨¼
--quad-mode hybrid
--min-mouth-w-ratio 0.15

# 3. ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’èª¿æ•´
--sprite-aspect 1.2  # æ¨ªé•·ã«ã™ã‚‹
```

### å•é¡Œ5: é¼»ã¾ã§å«ã¾ã‚Œã¦ã—ã¾ã†

**ç—‡çŠ¶:**
quadãŒå¤§ãã™ãã¦ã€é¼»ã¾ã§è¦†ã£ã¦ã—ã¾ã†

**åŸå› :**
- `pad` ãŒå¤§ãã™ãã‚‹
- `min-mouth-w-ratio` ãŒå¤§ãã™ãã‚‹

**å¯¾å‡¦æ³•:**

```bash
# 1. ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™
--pad 1.8  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2.1

# 2. æœ€å°ã‚µã‚¤ã‚ºã‚’å°ã•ã
--min-mouth-w-ratio 0.10  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.12

# 3. ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’èª¿æ•´ï¼ˆç¸¦ã‚’çŸ­ãï¼‰
--sprite-aspect 1.5  # ã‚ˆã‚Šæ¨ªé•·ã«
```

### å•é¡Œ6: è§’åº¦ãŒæ€¥æ¿€ã«å¤‰ã‚ã‚‹

**ç—‡çŠ¶:**
ãƒ‡ãƒãƒƒã‚°å‹•ç”»ã§quadãŒçªç„¶å›è»¢ã™ã‚‹

**åŸå› :**
- æ¤œå‡ºã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚‹å¤–ã‚Œå€¤
- ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãŒåŠ¹ã„ã¦ã„ãªã„

**å¯¾å‡¦æ³•:**

```bash
# 1. è§’åº¦å¤‰åŒ–ã‚’å³ã—ãåˆ¶é™
--max-angle-change 10.0  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 15.0

# 2. ã‚«ãƒƒãƒˆã‚ªãƒ•å‘¨æ³¢æ•°ã‚’ä¸‹ã’ã‚‹
--smooth-cutoff 2.0

# 3. æ¤œå‡ºå“è³ªã‚’ä¸Šã’ã¦èª¤æ¤œå‡ºã‚’æ¸›ã‚‰ã™
--min-conf 0.6
--det-scale 1.0
```

### å•é¡Œ7: å‡¦ç†ãŒé…ã™ãã‚‹

**ç—‡çŠ¶:**
ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã‚‹

**å¯¾å‡¦æ³•:**

```bash
# 1. å“è³ªãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¸‹ã’ã‚‹
--quality fast  # ã¾ãŸã¯ normal

# 2. æ¤œå‡ºè§£åƒåº¦ã‚’ä¸‹ã’ã‚‹
--det-scale 0.5

# 3. ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’å¢—ã‚„ã™
--stride 2  # 2ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨

# 4. CPUã®å ´åˆã¯GPUã‚’ä½¿ã†
--device cuda:0

# çµ„ã¿åˆã‚ã›ä¾‹ï¼ˆé«˜é€Ÿè¨­å®šï¼‰
python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality fast \
    --device cuda:0
```

### å•é¡Œ8: ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ãŒé©ç”¨ã•ã‚Œãªã„

**ç—‡çŠ¶:**
```
[warn] skip smoothing: valid=3/100 (3.0%)
       < min_count=5 or min_ratio=5.0%
```

**åŸå› :**
- æ¤œå‡ºæˆåŠŸãƒ•ãƒ¬ãƒ¼ãƒ ãŒå°‘ãªã™ãã‚‹
- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã®å®‰å…¨åŸºæº–ã‚’æº€ãŸã—ã¦ã„ãªã„

**å¯¾å‡¦æ³•:**

```bash
# 1. æ¤œå‡ºç‡ã‚’æ”¹å–„ï¼ˆå•é¡Œ1ã‚’å‚ç…§ï¼‰
--det-scale 1.0
--min-conf 0.3

# 2. å®‰å…¨åŸºæº–ã‚’ç·©ã‚ã‚‹ï¼ˆéæ¨å¥¨ï¼‰
--valid-min-ratio 0.02  # 2%ä»¥ä¸Šã§è¨±å¯
--valid-min-count 3     # 3ãƒ•ãƒ¬ãƒ¼ãƒ ä»¥ä¸Šã§è¨±å¯

# æ³¨æ„: å®‰å…¨åŸºæº–ã‚’ç·©ã‚ã™ãã‚‹ã¨èª¤è£œé–“ã®ãƒªã‚¹ã‚¯ã‚ã‚Š
```

---

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã®ã‚³ãƒ„

### èª¿æ•´ã®å„ªå…ˆé †ä½

```
1. ã¾ãšæ¤œå‡ºç‡ã‚’æ”¹å–„ (valid_rate > 80%)
   â†“
2. quadã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´ (pad, min-mouth-w-*)
   â†“
3. ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã‚’èª¿æ•´ (smooth-cutoff)
   â†“
4. ç´°ã‹ã„èª¿æ•´ (max-angle-changeç­‰)
```

### ã‚ˆãã‚ã‚‹è¨­å®šãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: é«˜å“è³ªãƒ»ä½é€Ÿï¼ˆé…ä¿¡å‘ã‘æœ€çµ‚å‡ºåŠ›ï¼‰

```bash
python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality max \
    --quad-mode hybrid \
    --pad 2.2 \
    --smooth-cutoff 2.5 \
    --max-angle-change 12.0 \
    --debug mouth_track_debug.mp4
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒãƒ©ãƒ³ã‚¹ï¼ˆæ¨å¥¨ï¼‰

```bash
python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality normal \
    --quad-mode hybrid \
    --smooth-cutoff 3.0 \
    --debug mouth_track_debug.mp4
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: é«˜é€Ÿãƒ»ä½å“è³ªï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

```bash
python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality fast \
    --quad-mode bbox \
    --smooth-cutoff 4.0
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³4: æ¿€ã—ã„å‹•ã

```bash
python face_track_anime_detector.py \
    --video fast_motion.mp4 \
    --out mouth_track.npz \
    --quality high \
    --stride 1 \
    --quad-mode hybrid \
    --smooth-cutoff 5.0 \
    --max-angle-change 20.0 \
    --debug mouth_track_debug.mp4
```

---

## ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã®è¦‹æ–¹

### ãƒ‡ãƒãƒƒã‚°å‹•ç”»

`--debug mouth_track_debug.mp4` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒæç”»ã•ã‚Œã¾ã™:

#### æç”»å†…å®¹

```
[ç”»é¢ä¸Šéƒ¨ã®ãƒ†ã‚­ã‚¹ãƒˆ]
frame 42  valid=1  conf=0.87  faces=1  det=1
       â†‘        â†‘         â†‘        â†‘      â†‘
    ãƒ•ãƒ¬ãƒ¼ãƒ   æ¤œå‡ºæˆåŠŸ  ä¿¡é ¼åº¦   æ¤œå‡ºæ•°  æ¤œå‡ºå®Ÿè¡Œ
```

#### è‰²ã®æ„å‘³

- **ç·‘ã®quad**: æ¤œå‡ºæˆåŠŸ (valid=1)
- **èµ¤ã®quad**: æ¤œå‡ºå¤±æ•— (valid=0ã€è£œé–“ã•ã‚ŒãŸå€¤)
- **ç´«ã®ç‚¹**: 28ç‚¹ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯
- **é»„è‰²ã®ä¸¸**: å£ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ (24-27ç•ª)

#### ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

1. **quadãŒå£ã‚’è¦†ã£ã¦ã„ã‚‹ã‹**
   - å°ã•ã™ãã‚‹ â†’ `--pad` ã‚’å¢—ã‚„ã™
   - å¤§ãã™ãã‚‹ â†’ `--pad` ã‚’æ¸›ã‚‰ã™

2. **quadãŒæ»‘ã‚‰ã‹ã«å‹•ãã‹**
   - ã‚«ã‚¯ã‚«ã‚¯ â†’ `--smooth-cutoff` ã‚’ä¸‹ã’ã‚‹
   - é…å»¶ãŒç›®ç«‹ã¤ â†’ `--smooth-cutoff` ã‚’ä¸Šã’ã‚‹

3. **valid=0 ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå¤šã™ããªã„ã‹**
   - å¤šã„ â†’ æ¤œå‡ºç‡ã‚’æ”¹å–„ï¼ˆå•é¡Œ1å‚ç…§ï¼‰

4. **quadã®è§’åº¦ãŒæ€¥ã«å¤‰ã‚ã‚‰ãªã„ã‹**
   - å¤‰ã‚ã‚‹ â†’ `--max-angle-change` ã‚’ä¸‹ã’ã‚‹

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«

`--debug` æŒ‡å®šæ™‚ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ç”Ÿæˆã•ã‚Œã¾ã™:

#### mouth_track_debug.metrics.json

```json
{
  "video": "/path/to/loop.mp4",
  "out": "/path/to/mouth_track.npz",
  "metrics": {
    "n_frames": 300,
    "n_valid": 285,
    "valid_rate": 0.95,
    "mean_conf": 0.82,
    "p10_conf": 0.68,
    "min_conf_threshold": 0.5,
    "quad_width_median_px": 124.3,
    "jitter_p95_px": 2.1,
    "jitter_p95_over_width": 0.017
  },
  "params": { ... }
}
```

**é‡è¦ãªæŒ‡æ¨™:**

- `valid_rate`: 0.80ä»¥ä¸ŠãŒç†æƒ³
- `jitter_p95_over_width`: 0.10ä»¥ä¸‹ãŒç†æƒ³ï¼ˆã‚«ã‚¯ã¤ãã®æŒ‡æ¨™ï¼‰

#### mouth_track_debug.metrics.png

3ã¤ã®ã‚°ãƒ©ãƒ•:
- **confidence**: æ¤œå‡ºä¿¡é ¼åº¦ã®æ¨ç§»
- **valid**: æ¤œå‡ºæˆåŠŸ/å¤±æ•—ã®æ¨ç§»ï¼ˆ0/1ï¼‰
- **jitter_px**: ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã®ãƒ–ãƒ¬ï¼ˆãƒ”ã‚¯ã‚»ãƒ«å˜ä½ï¼‰

---

## ã¾ã¨ã‚

### æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆåˆã‚ã¦ä½¿ã†å ´åˆï¼‰

```bash
# 1. ã¾ãšnormalã§è©¦ã™
uv run python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality normal \
    --debug mouth_track_debug.mp4

# 2. ãƒ‡ãƒãƒƒã‚°å‹•ç”»ã‚’ç¢ºèª
# - quadãŒå£ã‚’è¦†ã£ã¦ã„ã‚‹ã‹
# - æ»‘ã‚‰ã‹ã«å‹•ã„ã¦ã„ã‚‹ã‹

# 3. å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
# - valid_rate < 80% â†’ --det-scale 1.0
# - quadãŒå°ã•ã„ â†’ --pad 2.5
# - ã‚«ã‚¯ã‚«ã‚¯ã™ã‚‹ â†’ --smooth-cutoff 2.5

# 4. æœ€çµ‚å‡ºåŠ›
uv run python face_track_anime_detector.py \
    --video loop.mp4 \
    --out mouth_track.npz \
    --quality high \
    --quad-mode hybrid \
    --pad 2.2 \
    --smooth-cutoff 2.5
```

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

| å•é¡Œ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æ–¹å‘ |
|-----|----------|------|
| æ¤œå‡ºç‡ãŒä½ã„ | `--det-scale` | â†‘ |
| æ¤œå‡ºç‡ãŒä½ã„ | `--min-conf` | â†“ |
| quadãŒå°ã•ã„ | `--pad` | â†‘ |
| quadãŒå¤§ãã„ | `--pad` | â†“ |
| ã‚«ã‚¯ã‚«ã‚¯ã™ã‚‹ | `--smooth-cutoff` | â†“ |
| é…å»¶ãŒç›®ç«‹ã¤ | `--smooth-cutoff` | â†‘ |
| è§’åº¦ãŒè·³ã­ã‚‹ | `--max-angle-change` | â†“ |
| å‡¦ç†ãŒé…ã„ | `--det-scale` | â†“ |
| å‡¦ç†ãŒé…ã„ | `--stride` | â†‘ |

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ—¥**: 2026-01-20
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: MotionPNGTuber æœ€æ–°ç‰ˆ
