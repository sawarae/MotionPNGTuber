# å£æ¶ˆã—ãƒ„ãƒ¼ãƒ« è§£èª¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

MotionPNGTuberãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ã‚¢ãƒ‹ãƒ¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å£éƒ¨åˆ†ã‚’è‡ªå‹•çš„ã«é™¤å»ã™ã‚‹ãŸã‚ã®3ã¤ã®ãƒ„ãƒ¼ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒ„ãƒ¼ãƒ«ä¸€è¦§](#ãƒ„ãƒ¼ãƒ«ä¸€è¦§)
   - [mouth_erase_tuner_gui.py - é™æ­¢ç”»ç”¨GUI](#1-mouth_erase_tuner_guipy---é™æ­¢ç”»ç”¨gui)
   - [erase_mouth_offline.py - å‹•ç”»ç”¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³](#2-erase_mouth_offlinepy---å‹•ç”»ç”¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³)
   - [auto_erase_mouth.py - è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ãƒƒãƒ‘ãƒ¼](#3-auto_erase_mouthpy---è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ãƒƒãƒ‘ãƒ¼)
3. [æŠ€è¡“çš„ãªä»•çµ„ã¿](#æŠ€è¡“çš„ãªä»•çµ„ã¿)
4. [ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¬ã‚¤ãƒ‰](#ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¬ã‚¤ãƒ‰)

---

## æ¦‚è¦

å£æ¶ˆã—ãƒ„ãƒ¼ãƒ«ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å£ãƒ‘ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰å‡¦ç†ã¨ã—ã¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å£ã‚’é™¤å»ã—ãŸã€Œãƒ™ãƒ¼ã‚¹å‹•ç”»/ç”»åƒã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚é™¤å»ã•ã‚ŒãŸå£ã®éƒ¨åˆ†ã«ã¯ã€å¾Œã‹ã‚‰å‹•çš„ãªå£ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’åˆæˆã—ã¾ã™ã€‚

### ä¸»ãªç”¨é€”

- **å‹•ç”»**: ãƒ«ãƒ¼ãƒ—å‹•ç”»ã‹ã‚‰å£ã‚’æ¶ˆå»ã—ã€å£ãƒ‘ã‚¯ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ™ãƒ¼ã‚¹å‹•ç”»ã‚’ä½œæˆ
- **é™æ­¢ç”»**: 1æšã®ç”»åƒã§å£æ¶ˆã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- **è‡ªå‹•åŒ–**: è¤‡æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã¦æœ€é©ãªçµæœã‚’è‡ªå‹•é¸æŠ

---

## ãƒ„ãƒ¼ãƒ«ä¸€è¦§

### 1. mouth_erase_tuner_gui.py - é™æ­¢ç”»ç”¨GUI

**ç›®çš„**: é™æ­¢ç”»ã«å¯¾ã—ã¦å£æ¶ˆã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç´ æ—©ãè©¦è¡ŒéŒ¯èª¤ã§ãã‚‹GUIãƒ„ãƒ¼ãƒ«

#### èµ·å‹•æ–¹æ³•

```bash
uv run python mouth_erase_tuner_gui.py
```

#### ä¸»ãªæ©Ÿèƒ½

##### ğŸ“‚ ç”»åƒæ“ä½œ
- **ç”»åƒã‚’é–‹ã**: å˜ä¸€ç”»åƒã‚’é¸æŠ
- **ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã**: è¤‡æ•°ç”»åƒã‚’ä¸€æ‹¬èª­ã¿è¾¼ã¿
- **Prev/Next**: ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ç”»åƒã‚’é †ç•ªã«è¡¨ç¤º
- **Drag & Drop**: ç”»åƒ/ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ï¼ˆtkinterdnd2ãŒå¿…è¦ï¼‰

##### ğŸ” æ¤œå‡ºè¨­å®š (anime-face-detector)

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `device` | å®Ÿè¡Œãƒ‡ãƒã‚¤ã‚¹ | auto | auto, cpu, cuda:0, cuda:1 |
| `det_scale` | æ¤œå‡ºæ™‚ã®ç”»åƒã‚¹ã‚±ãƒ¼ãƒ« | 1.0 | 0.5 ~ 1.5 |
| `min_conf` | æœ€å°ä¿¡é ¼åº¦ | 0.5 | 0.0 ~ 0.99 |
| `sprite_aspect` | å£ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” | 1.0 | 0.7 ~ 3.0 |
| `pad` | å£é ˜åŸŸã®æ‹¡å¤§å€ç‡ | 2.1 | 1.0 ~ 3.0 |
| `quad_mode` | å£é ˜åŸŸã®æ¨å®šæ–¹æ³• | hybrid | hybrid, mouth, bbox |
| `min_mouth_w_ratio` | æœ€å°å£å¹…ï¼ˆé¡”å¹…ã«å¯¾ã™ã‚‹æ¯”ç‡ï¼‰ | 0.12 | 0.0 ~ 0.40 |
| `min_mouth_w_px` | æœ€å°å£å¹…ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ | 16.0 | 0.0 ~ 64.0 |

**quad_mode ã®é•ã„:**
- `hybrid`: å£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ + æœ€å°ã‚µã‚¤ã‚ºä¿è¨¼ï¼ˆæ¨å¥¨ï¼‰
- `mouth`: å£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®ã¿ã‹ã‚‰æ¨å®š
- `bbox`: é¡”å…¨ä½“ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰æ¨å®š

##### ğŸ¨ å£æ¶ˆã—è¨­å®š

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç¯„å›² |
|-----------|------|----------|------|
| `coverage` | è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°å€¤ï¼ˆ0=ç‹­ã„ã€1=åºƒã„ï¼‰ | 0.60 | 0.0 ~ 1.0 |
| `mask_scale_x` | ãƒã‚¹ã‚¯ã®æ¨ªå¹…ã‚¹ã‚±ãƒ¼ãƒ« | 0.62 | 0.35 ~ 0.95 |
| `mask_scale_y` | ãƒã‚¹ã‚¯ã®ç¸¦å¹…ã‚¹ã‚±ãƒ¼ãƒ« | 0.62 | 0.30 ~ 0.95 |
| `ring_px` | å‘¨å›²ãƒªãƒ³ã‚°å¹…ï¼ˆè‰²åˆã‚ã›ç”¨ï¼‰ | 18 | 0 ~ 60 |
| `dilate_px` | ãƒã‚¹ã‚¯è†¨å¼µãƒ”ã‚¯ã‚»ãƒ« | 10 | 0 ~ 60 |
| `feather_px` | ã¼ã‹ã—å¹… | 20 | 0 ~ 80 |
| `inpaint_radius` | ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆåŠå¾„ | 5.0 | 0.0 ~ 15.0 |
| `top_clip_frac` | é¼»ä¿è­·ï¼ˆä¸Šéƒ¨ã‚¯ãƒªãƒƒãƒ—ï¼‰ | 0.82 | 0.60 ~ 1.0 |
| `center_y_off_frac` | ãƒã‚¹ã‚¯ä¸­å¿ƒã®Yè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆ | 0.05 | 0.00 ~ 0.20 |

**coverage ã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**:
`coverage ã§è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°`ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€`coverage`å€¤ï¼ˆ0~1ï¼‰ã«åŸºã¥ã„ã¦ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚

- **ä½ã„å€¤ (0.3~0.5)**: ç‹­ã„ç¯„å›²ã‚’æ¶ˆå»ï¼ˆé¼»ã«å®‰å…¨ï¼‰
- **ä¸­é–“å€¤ (0.6~0.7)**: ãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼ˆæ¨å¥¨ï¼‰
- **é«˜ã„å€¤ (0.8~1.0)**: åºƒç¯„å›²ã‚’æ¶ˆå»ï¼ˆæ¿€ã—ã„å‹•ãã«å¯¾å¿œï¼‰

##### ğŸ–¼ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º

3ã¤ã®ã‚¿ãƒ–ã§çµæœã‚’ç¢ºèª:

1. **çµæœã‚¿ãƒ–**: Before/After ã®æ¯”è¼ƒ
2. **ãƒã‚¹ã‚¯ã‚¿ãƒ–**: å†…å´ãƒã‚¹ã‚¯/ãƒ•ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¯ã®ç¢ºèª
3. **ãƒ‘ãƒƒãƒã‚¿ãƒ–**: æ­£è¦åŒ–ãƒ‘ãƒƒãƒï¼ˆå…ƒ/æ¶ˆå»å¾Œï¼‰

##### ğŸ’¾ ä¿å­˜æ©Ÿèƒ½

- **ç”»åƒã¨ã—ã¦ä¿å­˜**: å‡¦ç†çµæœã‚’PNG/JPGã§ä¿å­˜
- **è¨­å®šã‚’JSONä¿å­˜**: ç¾åœ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
- **è¨­å®šã‚’JSONèª­è¾¼**: ä¿å­˜ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹

```
1. ç”»åƒã‚’é–‹ãï¼ˆã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãï¼‰
2. ã€Œæ¤œå‡ºâ†’å£æ¶ˆã—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ãªãŒã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
4. è‰¯ã„çµæœãŒå¾—ã‚‰ã‚ŒãŸã‚‰ã€Œç”»åƒã¨ã—ã¦ä¿å­˜ã€
5. ã€Œè¨­å®šã‚’JSONä¿å­˜ã€ã§æ¬¡å›ã‚‚åŒã˜è¨­å®šã‚’ä½¿ç”¨å¯èƒ½
```

---

### 2. erase_mouth_offline.py - å‹•ç”»ç”¨ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³

**ç›®çš„**: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦å‹•ç”»ã‹ã‚‰å£ã‚’é«˜å“è³ªã«é™¤å»

#### æŠ€è¡“çš„ç‰¹å¾´

**æ™‚é–“çš„å®‰å®šæ€§ã‚’é‡è¦–ã—ãŸå‡¦ç†:**

1. **æ­£è¦åŒ–ç©ºé–“ã§ã®å‡¦ç†**: å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®å£ãƒ‘ãƒƒãƒã‚’å›ºå®šã‚µã‚¤ã‚ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ¯ãƒ¼ãƒ—
2. **å˜ä¸€ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ã§1å›ã ã‘ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆå‡¦ç†
3. **ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®é™°å½±æ¨å®š**: ãƒªãƒ³ã‚°é ˜åŸŸã‹ã‚‰é™°å½±/è‰²ã‚’æ¨å®šã—ã€ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«é©ç”¨
4. **é€†ãƒ¯ãƒ¼ãƒ—ï¼‹ãƒ–ãƒ¬ãƒ³ãƒ‰**: ãƒ•ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¯ã§å…ƒãƒ•ãƒ¬ãƒ¼ãƒ ã«åˆæˆ

ã“ã®æ‰‹æ³•ã«ã‚ˆã‚Šã€ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã§è‰²ãŒå¤‰ã‚ã‚‹ã€Œã¡ã‚‰ã¤ãã€ã‚’é˜²æ­¢ã—ã¾ã™ã€‚

#### èµ·å‹•æ–¹æ³•

```bash
uv run python erase_mouth_offline.py \
  --video loop.mp4 \
  --track mouth_track_calibrated.npz \
  --out loop_mouthless.mp4 \
  --coverage 0.70 \
  --keep-audio
```

#### ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|-----------|------|----------|
| `--video` | å…¥åŠ›å‹•ç”» | (å¿…é ˆ) |
| `--track` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿(.npz) | è‡ªå‹•æ¤œç´¢ |
| `--out` | å‡ºåŠ›å‹•ç”» | *_mouthless.mp4 |
| `--valid-policy` | ç„¡åŠ¹ãƒ•ãƒ¬ãƒ¼ãƒ ã®å‡¦ç†æ–¹æ³• | hold |
| `--ref-frame` | å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå· | -1 (è‡ªå‹•) |
| `--coverage` | æ¶ˆå»ç¯„å›²ï¼ˆ0~1ï¼‰ | -1.0ï¼ˆè‡ªå‹•ï¼‰ |
| `--oversample` | æ­£è¦åŒ–ãƒ‘ãƒƒãƒã®ã‚µã‚¤ã‚ºå€ç‡ | 1.2 |
| `--shading` | é™°å½±ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³• | plane |
| `--keep-audio` | éŸ³å£°ã‚’ä¿æŒï¼ˆffmpegå¿…è¦ï¼‰ | false |
| `--codec` | å‡ºåŠ›ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ | mp4v |

#### è©³ç´°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**ãƒã‚¹ã‚¯å½¢çŠ¶:**
- `--mask-scale-x`: æ¨ªå¹…ã‚¹ã‚±ãƒ¼ãƒ« (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.62)
- `--mask-scale-y`: ç¸¦å¹…ã‚¹ã‚±ãƒ¼ãƒ« (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.62)
- `--ring`: ãƒªãƒ³ã‚°å¹… (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 18)
- `--dilate`: ãƒã‚¹ã‚¯è†¨å¼µ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10)
- `--feather`: ã¼ã‹ã—å¹… (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20)
- `--inpaint-radius`: ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆåŠå¾„ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5.0)

**æ­£è¦åŒ–ãƒ‘ãƒƒãƒã‚µã‚¤ã‚º:**
- `--norm-w`: å¹…ã‚’å›ºå®š (0=è‡ªå‹•)
- `--norm-h`: é«˜ã•ã‚’å›ºå®š (0=è‡ªå‹•)

#### valid-policy ã®å‹•ä½œ

- `hold`: ç„¡åŠ¹ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ç›´å‰ã®æœ‰åŠ¹ãªquadã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
- `strict`: ç„¡åŠ¹ãƒ•ãƒ¬ãƒ¼ãƒ ã¯å…ƒãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãã®ã¾ã¾å‡ºåŠ›

#### coverage ã®æ¨å¥¨å€¤

| å€¤ | ç”¨é€” | èª¬æ˜ |
|----|-----|------|
| 0.3~0.5 | é™æ­¢ç”»ãƒ»å¾®å‹• | ç‹­ã„ç¯„å›²ã€é¼»ã«å®‰å…¨ |
| 0.6~0.7 | æ¨™æº– | ãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼ˆæ¨å¥¨ï¼‰ |
| 0.8~1.0 | æ¿€ã—ã„å‹•ã | åºƒç¯„å›²ã‚’æ¶ˆå»ã€é«˜é€Ÿãªå£ã®å‹•ãã«å¯¾å¿œ |

#### ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›

```bash
--debug debug_output/
```

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™:
- `ref_patch.png`: å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ‘ãƒƒãƒ
- `clean_patch.png`: ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ãƒ‘ãƒƒãƒ
- `mask_inner.png`: å†…å´ãƒã‚¹ã‚¯
- `mask_ring.png`: ãƒªãƒ³ã‚°ãƒã‚¹ã‚¯
- `frame_XXXXXX.png`: å‡¦ç†ä¸­ã®ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ120ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ï¼‰
- `metrics.json`: å‡¦ç†ãƒ¡ãƒˆãƒªã‚¯ã‚¹

---

### 3. auto_erase_mouth.py - è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ©ãƒƒãƒ‘ãƒ¼

**ç›®çš„**: è¤‡æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€™è£œã‚’è‡ªå‹•çš„ã«è©¦è¡Œã—ã€æœ€è‰¯ã®çµæœã‚’é¸æŠ

#### èµ·å‹•æ–¹æ³•

```bash
uv run python auto_erase_mouth.py \
  --video loop.mp4 \
  --track mouth_track_calibrated.npz \
  --out loop_mouthless.mp4 \
  --coverage "0.60,0.70,0.80" \
  --try-strict \
  --keep-audio
```

#### ä¸»ãªæ©Ÿèƒ½

##### ğŸ¯ ã‚¹ãƒãƒ¼ãƒˆãªå‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠ

é«˜ä¿¡é ¼åº¦ã®å€™è£œã‹ã‚‰ã€Œå£ãŒé–‰ã˜ã¦ã„ã‚‹ã€ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å„ªå…ˆé¸æŠ:
- é«˜ä¿¡é ¼åº¦ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä¸­ã‹ã‚‰48å€‹ã‚’å€™è£œã¨ã—ã¦æŠ½å‡º
- å„å€™è£œã®å£é ˜åŸŸã®åˆ†æ•£ãƒ»ã‚¨ãƒƒã‚¸ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è¨ˆç®—
- ã‚¹ã‚³ã‚¢ãŒä½ã„ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ï¼å£ãŒé–‰ã˜ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„

##### ğŸ“Š å“è³ªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã‚’è¤‡æ•°ã®æŒ‡æ¨™ã§è©•ä¾¡:

1. **ç¶™ç¶šæ€§**: å†…å´ã®å¹³å‡è¼åº¦ â‰’ ãƒªãƒ³ã‚°ã®å¹³å‡è¼åº¦
2. **ãƒ†ã‚¯ã‚¹ãƒãƒ£**: å†…å´é ˜åŸŸã®å‹¾é…ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä½ã„
3. **ä¾µå…¥æ¤œå‡º**: é¼»ãƒ»é ¬é ˜åŸŸã®å¤‰åŒ–ã‚’æ¤œå‡ºï¼ˆéå‰°ãªæ¶ˆå»ã‚’é˜²æ­¢ï¼‰

ã‚¹ã‚³ã‚¢ãŒä½ã„ã»ã©é«˜å“è³ªã¨åˆ¤å®šã•ã‚Œã¾ã™ã€‚

##### ğŸ”„ è¤‡æ•°å€™è£œã®è©¦è¡Œ

- è¤‡æ•°ã®`coverage`å€¤ã‚’è©¦è¡Œ
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§`hold`ã¨`strict`ãƒãƒªã‚·ãƒ¼ã‚’ä¸¡æ–¹è©¦è¡Œ
- å„å€™è£œã‚’å®Ÿéš›ã«å‡¦ç†ã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
- æœ€è‰¯ã®çµæœã‚’è‡ªå‹•é¸æŠ

#### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|-----------|------|----------|
| `--video` | å…¥åŠ›å‹•ç”» | (å¿…é ˆ) |
| `--track` | ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ | (å¿…é ˆ) |
| `--out` | å‡ºåŠ›å‹•ç”» | (å¿…é ˆ) |
| `--erase` | erase_mouth_offline.pyã®ãƒ‘ã‚¹ | erase_mouth_offline.py |
| `--coverage` | è©¦è¡Œã™ã‚‹coverageå€¤ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ | 0.60,0.70,0.80 |
| `--valid-policy` | ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒãƒªã‚·ãƒ¼ | hold |
| `--try-strict` | strictãƒãƒªã‚·ãƒ¼ã‚‚è©¦è¡Œ | false |
| `--ref-mode` | å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ é¸æŠæ–¹æ³• | smart |
| `--ref-topk` | å€™è£œãƒ•ãƒ¬ãƒ¼ãƒ æ•° | 48 |
| `--keep-audio` | éŸ³å£°ã‚’ä¿æŒ | false |
| `--shading` | é™°å½±ãƒãƒƒãƒãƒ³ã‚°æ–¹æ³• | plane |
| `--qa-samples` | å“è³ªè©•ä¾¡ç”¨ã‚µãƒ³ãƒ—ãƒ«æ•° | 12 |
| `--debug` | ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | (ç©º) |

#### ref-mode ã®ç¨®é¡

- `smart`: é–‰ã˜ãŸå£ã‚’å„ªå…ˆï¼ˆæ¨å¥¨ï¼‰
- `confidence`: æœ€é«˜ä¿¡é ¼åº¦ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨
- `first`: æœ€åˆã®æœ‰åŠ¹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½¿ç”¨

#### ä¾µå…¥æ¤œå‡ºã®ä»•çµ„ã¿

**INVASION_WEIGHT = 2.0**: é¼»ãƒ»é ¬é ˜åŸŸã®å¤‰åŒ–ã«å¯¾ã™ã‚‹ãƒšãƒŠãƒ«ãƒ†ã‚£é‡ã¿

å£æ¶ˆã—ãƒã‚¹ã‚¯ãŒå¤§ãã™ãã‚‹ã¨ã€æœ¬æ¥æ¶ˆã—ã¦ã¯ã„ã‘ãªã„é¼»ã‚„é ¬ã®ãƒ©ã‚¤ãƒ³ã¾ã§æ¶ˆã—ã¦ã—ã¾ã„ã¾ã™ã€‚è‡ªå‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ä»¥ä¸‹ã®é ˜åŸŸã‚’ãƒã‚§ãƒƒã‚¯:

- **é¼»é ˜åŸŸ**: ä¸Šéƒ¨ä¸­å¤®ï¼ˆé¡”ã®10~38%ã®é«˜ã•ã€å¹…30~70%ï¼‰
- **é ¬é ˜åŸŸ**: å·¦å³å´é¢ï¼ˆé¡”ã®38~90%ã®é«˜ã•ï¼‰

ã“ã‚Œã‚‰ã®é ˜åŸŸã§ã‚ªãƒªã‚¸ãƒŠãƒ«ã¨ã®å·®åˆ†ãŒå¤§ãã„å ´åˆã€ã‚¹ã‚³ã‚¢ãŒé«˜ããªã‚Šï¼ˆ=å“è³ªãŒä½ã„ï¼‰ã€ãã®è¨­å®šã¯æ¡ç”¨ã•ã‚Œã«ãããªã‚Šã¾ã™ã€‚

---

## æŠ€è¡“çš„ãªä»•çµ„ã¿

### æ­£è¦åŒ–ç©ºé–“ã§ã®å‡¦ç†ï¼ˆerase_mouth_offline.pyï¼‰

```
[å…ƒãƒ•ãƒ¬ãƒ¼ãƒ ] â†’ [ãƒ¯ãƒ¼ãƒ—] â†’ [æ­£è¦åŒ–ãƒ‘ãƒƒãƒ] â†’ [ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆ] â†’ [ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ]
                   â†“                                    â†“
              [é™°å½±æ¨å®š] â† â† â† â† â† â† â† â† â† â† â† â† [é™°å½±é©ç”¨]
                   â†“                                    â†“
              [é€†ãƒ¯ãƒ¼ãƒ—] â† â† â† â† â† â† â† â† â† â† â† â† [åˆæˆãƒ‘ãƒƒãƒ]
                   â†“
            [ãƒ•ã‚§ã‚¶ãƒ¼ãƒ–ãƒ¬ãƒ³ãƒ‰]
                   â†“
            [å‡ºåŠ›ãƒ•ãƒ¬ãƒ¼ãƒ ]
```

#### ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¬ãƒ™ãƒ«ï¼‰

##### 1. **ãƒ¯ãƒ¼ãƒ—ï¼ˆæ­£è¦åŒ–ç©ºé–“ã¸ã®å¤‰æ›ï¼‰**

```python
# é–¢æ•°: warp_frame_to_norm()
# ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: OpenCV

# ã‚¹ãƒ†ãƒƒãƒ—1: å¤‰æ›è¡Œåˆ—ã®è¨ˆç®—
src_pts = quad.reshape(4, 2)  # å…ƒç”»åƒã®4ç‚¹åº§æ¨™ (numpy array)
dst_pts = np.array([
    [0, 0],                      # å·¦ä¸Š
    [norm_w-1, 0],               # å³ä¸Š
    [norm_w-1, norm_h-1],        # å³ä¸‹
    [0, norm_h-1]                # å·¦ä¸‹
], dtype=np.float32)

M = cv2.getPerspectiveTransform(src_pts, dst_pts)
# â†’ 3x3ã®ãƒ‘ãƒ¼ã‚¹ãƒšã‚¯ãƒ†ã‚£ãƒ–å¤‰æ›è¡Œåˆ—ã‚’å–å¾—

# ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¯ãƒ¼ãƒ—å‡¦ç†
patch = cv2.warpPerspective(
    frame_bgr,                   # å…¥åŠ›ç”»åƒ (H,W,3) BGR
    M,                           # å¤‰æ›è¡Œåˆ— (3,3)
    (norm_w, norm_h),            # å‡ºåŠ›ã‚µã‚¤ã‚º
    flags=cv2.INTER_LINEAR,      # åŒç·šå½¢è£œé–“
    borderMode=cv2.BORDER_REPLICATE  # å¢ƒç•Œã¯ã‚¨ãƒƒã‚¸ãƒ”ã‚¯ã‚»ãƒ«ã‚’è¤‡è£½
)
# â†’ æ­£è¦åŒ–ãƒ‘ãƒƒãƒ (norm_h, norm_w, 3) ã‚’å–å¾—
```

**å‡¦ç†å†…å®¹**:
- `cv2.getPerspectiveTransform()`: 4ç‚¹å¯¾å¿œã‹ã‚‰ãƒ›ãƒ¢ã‚°ãƒ©ãƒ•ã‚£è¡Œåˆ—ã‚’è¨ˆç®—ï¼ˆ3x3è¡Œåˆ—ï¼‰
- `cv2.warpPerspective()`: ãƒ‘ãƒ¼ã‚¹ãƒšã‚¯ãƒ†ã‚£ãƒ–å¤‰æ›ã‚’é©ç”¨
  - å…ƒç”»åƒã®æ­ªã‚“ã å››è§’å½¢ã‚’ã€æ­£æ–¹å½¢/é•·æ–¹å½¢ã®å›ºå®šã‚µã‚¤ã‚ºã«å¤‰æ›
  - å›è»¢ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»é è¿‘æ³•ã«ã‚ˆã‚‹æ­ªã¿ã‚’ã™ã¹ã¦è£œæ­£

---

##### 2. **ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆï¼ˆå£ã®é™¤å»ï¼‰**

```python
# é–¢æ•°: å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ã§1å›ã ã‘å®Ÿè¡Œ
# ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: OpenCV

# ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚¹ã‚¯ä½œæˆ
inner_u8 = make_mouth_mask(
    norm_w, norm_h,
    rx=int(norm_w * mask_scale_x * 0.5),  # æ¥•å††ã®æ¨ªåŠå¾„
    ry=int(norm_h * mask_scale_y * 0.5),  # æ¥•å††ã®ç¸¦åŠå¾„
    center_y_offset_px=center_y_off,      # ä¸­å¿ƒã®Yè»¸ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    top_clip_frac=top_clip_frac           # ä¸Šéƒ¨ã‚¯ãƒªãƒƒãƒ—ç‡
)
# â†’ å£ãƒã‚¹ã‚¯ (norm_h, norm_w) uint8, å€¤ã¯0ã¾ãŸã¯255

# å†…éƒ¨å‡¦ç†:
mask = np.zeros((h, w), dtype=np.uint8)
cv2.ellipse(
    mask,
    (cx, cy),           # ä¸­å¿ƒåº§æ¨™
    (rx, ry),           # åŠå¾„
    0.0,                # å›è»¢è§’åº¦
    0.0, 360.0,         # é–‹å§‹è§’åº¦ã€çµ‚äº†è§’åº¦ï¼ˆæ¥•å††å…¨ä½“ï¼‰
    255,                # å¡—ã‚Šã¤ã¶ã—è‰²
    -1                  # å¡—ã‚Šã¤ã¶ã—ï¼ˆ-1ï¼‰
)
# ä¸Šéƒ¨ã‚’ã‚¯ãƒªãƒƒãƒ—ã—ã¦é¼»ã‚’ä¿è­·
clip_y = int(cy - ry * top_clip_frac)
mask[:clip_y, :] = 0

# ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆå‡¦ç†
clean_patch = cv2.inpaint(
    ref_patch,                        # å‚ç…§ãƒ‘ãƒƒãƒ (norm_h, norm_w, 3) BGR
    inner_u8,                         # ãƒã‚¹ã‚¯ (255ã®éƒ¨åˆ†ã‚’ä¿®å¾©)
    inpaintRadius=inpaint_radius,     # ä¿®å¾©ã«ä½¿ã†å‘¨è¾ºãƒ”ã‚¯ã‚»ãƒ«ã®åŠå¾„
    flags=cv2.INPAINT_TELEA           # Teleaæ³•ï¼ˆé«˜é€Ÿãƒ»è‡ªç„¶ï¼‰
)
# â†’ ã‚¯ãƒªãƒ¼ãƒ³ãƒ‘ãƒƒãƒ (norm_h, norm_w, 3) BGR
```

**cv2.inpaint() ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
- `INPAINT_TELEA`: Fast Marching Method (FMM) ãƒ™ãƒ¼ã‚¹
  - ãƒã‚¹ã‚¯é ˜åŸŸã®å¢ƒç•Œã‹ã‚‰å†…å´ã«å‘ã‹ã£ã¦ã€å‘¨è¾ºãƒ”ã‚¯ã‚»ãƒ«ã®å‹¾é…ã‚’è€ƒæ…®ã—ã¦å¡—ã‚Šã¤ã¶ã—
  - inpaintRadius: ã“ã®ç¯„å›²å†…ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚’å‚ç…§ã—ã¦ä¿®å¾©
  - é«˜é€Ÿã§è‡ªç„¶ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹

---

##### 3. **ãƒªãƒ³ã‚°é ˜åŸŸã®é™°å½±æ¨å®š**

```python
# é–¢æ•°: PlaneFitter ã‚¯ãƒ©ã‚¹ã§å‰å‡¦ç† + ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«fit/eval
# ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: OpenCV (è‰²ç©ºé–“å¤‰æ›), NumPy (ç·šå½¢ä»£æ•°)

# ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒ³ã‚°ãƒã‚¹ã‚¯ã®ç”Ÿæˆ
outer_u8 = make_mouth_mask(
    norm_w, norm_h,
    rx=rx + ring_px,         # å¤–å´æ¥•å††ã®æ¨ªåŠå¾„
    ry=ry + ring_px,         # å¤–å´æ¥•å††ã®ç¸¦åŠå¾„
    ...
)
ring_u8 = cv2.subtract(outer_u8, inner_u8)  # å¤–å´ - å†…å´ = ãƒªãƒ³ã‚°
ring_ys, ring_xs = np.where(ring_u8 > 0)    # ãƒªãƒ³ã‚°é ˜åŸŸã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™

# ã‚¹ãƒ†ãƒƒãƒ—2: è‰²ç©ºé–“å¤‰æ›ï¼ˆBGR â†’ L*a*b*ï¼‰
ref_patch_lab = cv2.cvtColor(ref_patch, cv2.COLOR_BGR2LAB).astype(np.float32)
# â†’ (norm_h, norm_w, 3) float32
#    [:,:,0] = L (è¼åº¦: 0~100ç›¸å½“ã€å®Ÿéš›ã¯0~255ã«ã‚¹ã‚±ãƒ¼ãƒ«)
#    [:,:,1] = a (ç·‘-èµ¤: -128~127)
#    [:,:,2] = b (é’-é»„: -128~127)

# ã‚¹ãƒ†ãƒƒãƒ—3: 2Då¹³é¢ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚° (å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ )
# L ~ a*x + b*y + c ã®å½¢ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆæœ€å°äºŒä¹—æ³•ï¼‰

# å‰å‡¦ç†ï¼ˆåˆæœŸåŒ–æ™‚ã«1å›ã®ã¿å®Ÿè¡Œï¼‰:
plane_fitter = PlaneFitter.from_ring(ring_xs, ring_ys, norm_w, norm_h)

# å†…éƒ¨å‡¦ç†:
# åº§æ¨™ã‚’æ­£è¦åŒ– (ç”»åƒåº§æ¨™ â†’ [-1, 1])
xn = (ring_xs - norm_w*0.5) / (norm_w*0.5)  # -1~1ã«æ­£è¦åŒ–
yn = (ring_ys - norm_h*0.5) / (norm_h*0.5)  # -1~1ã«æ­£è¦åŒ–

# ãƒ‡ã‚¶ã‚¤ãƒ³è¡Œåˆ— A ã‚’æ§‹ç¯‰
A = np.stack([xn, yn, np.ones_like(xn)], axis=1)  # (K, 3)

# ç–‘ä¼¼é€†è¡Œåˆ—ã‚’äº‹å‰è¨ˆç®—ï¼ˆé«˜é€ŸåŒ–ï¼‰
pinvA = np.linalg.pinv(A)  # (3, K)

# ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰ã‚’äº‹å‰è¨ˆç®—
gx = (np.arange(norm_w) - norm_w*0.5) / (norm_w*0.5)  # (norm_w,)
gy = (np.arange(norm_h) - norm_h*0.5) / (norm_h*0.5)  # (norm_h,)
X, Y = np.meshgrid(gx, gy)  # (norm_h, norm_w) ãšã¤

# ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®å‡¦ç†:
# å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ã®Lå€¤ã‚’æŠ½å‡º
L_ref = ref_patch_lab[:, :, 0][ring_ys, ring_xs]  # (K,) ãƒªãƒ³ã‚°é ˜åŸŸã®Lå€¤

# å¹³é¢ä¿‚æ•°ã‚’è¨ˆç®—ï¼ˆæœ€å°äºŒä¹—æ³•ï¼‰
plane_ref = pinvA @ L_ref  # (3,) = [a, b, c]

# ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã«å¹³é¢ã‚’è©•ä¾¡
plane_ref_grid = plane_ref[0]*X + plane_ref[1]*Y + plane_ref[2]  # (norm_h, norm_w)

# è‰²ç›¸ (a, b) ã®å¹³å‡å€¤
a_ref_mean = float(ref_patch_lab[:, :, 1][ring_ys, ring_xs].mean())
b_ref_mean = float(ref_patch_lab[:, :, 2][ring_ys, ring_xs].mean())
```

**å¹³é¢ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã®æ•°å­¦**:
```
ç›®çš„: L(x,y) = a*x + b*y + c ã‚’æœ€å°äºŒä¹—æ³•ã§æ±‚ã‚ã‚‹

A @ coeffs = L  ã‚’è§£ã
  A = [xn, yn, 1]^T  (Kå€‹ã®ã‚µãƒ³ãƒ—ãƒ«ç‚¹)
  coeffs = [a, b, c]^T
  L = [L_0, L_1, ..., L_{K-1}]^T

æœ€å°äºŒä¹—è§£: coeffs = (A^T A)^{-1} A^T L = pinv(A) @ L

PlaneFitterã§ã¯ pinv(A) ã‚’äº‹å‰è¨ˆç®—ã—ã¦é«˜é€ŸåŒ–
```

---

##### 4. **ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®é™°å½±é©ç”¨**

```python
# å„ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¯¾ã—ã¦å®Ÿè¡Œ

# ã‚¹ãƒ†ãƒƒãƒ—1: ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®ãƒ‘ãƒƒãƒã‚’è‰²ç©ºé–“å¤‰æ›
patch = warp_frame_to_norm(frame, quad, norm_w, norm_h)
patch_lab = cv2.cvtColor(patch, cv2.COLOR_BGR2LAB).astype(np.float32)

# ã‚¹ãƒ†ãƒƒãƒ—2: ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®é™°å½±ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ãƒ•ã‚£ãƒƒãƒˆ
L_i = patch_lab[:, :, 0][ring_ys, ring_xs]  # ãƒªãƒ³ã‚°é ˜åŸŸã®Lå€¤
plane_i = plane_fitter.fit(L_i)              # å¹³é¢ä¿‚æ•° [a, b, c]
plane_i_grid = plane_fitter.eval(plane_i)    # ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã«è©•ä¾¡

# ã‚¹ãƒ†ãƒƒãƒ—3: è‰²ç›¸ã®ã‚·ãƒ•ãƒˆé‡ã‚’è¨ˆç®—
a_i_mean = float(patch_lab[:, :, 1][ring_ys, ring_xs].mean())
b_i_mean = float(patch_lab[:, :, 2][ring_ys, ring_xs].mean())
da = a_i_mean - a_ref_mean  # aæ–¹å‘ã®ã‚·ãƒ•ãƒˆ
db = b_i_mean - b_ref_mean  # bæ–¹å‘ã®ã‚·ãƒ•ãƒˆ

# ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«é™°å½±ã‚’é©ç”¨
clean_lab_base = cv2.cvtColor(clean_patch, cv2.COLOR_BGR2LAB).astype(np.float32)

out_patch_lab = clean_lab_base.copy()
# L ãƒãƒ£ãƒ³ãƒãƒ«: å‚ç…§ã®é™°å½±ã‚’å¼•ã„ã¦ã€ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®é™°å½±ã‚’è¶³ã™
out_patch_lab[:, :, 0] = np.clip(
    out_patch_lab[:, :, 0] + (plane_i_grid - plane_ref_grid),
    0, 255
)
# a, b ãƒãƒ£ãƒ³ãƒãƒ«: å¹³å‡å€¤ã‚·ãƒ•ãƒˆ
out_patch_lab[:, :, 1] = np.clip(out_patch_lab[:, :, 1] + da, 0, 255)
out_patch_lab[:, :, 2] = np.clip(out_patch_lab[:, :, 2] + db, 0, 255)

# ã‚¹ãƒ†ãƒƒãƒ—5: BGRã«æˆ»ã™
out_patch = cv2.cvtColor(out_patch_lab.astype(np.uint8), cv2.COLOR_LAB2BGR)
```

**é™°å½±é©ç”¨ã®åŸç†**:
```
clean_plate ã®è¼åº¦: L_clean(x,y)
å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ã®è¼åº¦ãƒ¢ãƒ‡ãƒ«: L_ref(x,y) = a_ref*x + b_ref*y + c_ref
ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®è¼åº¦ãƒ¢ãƒ‡ãƒ«: L_i(x,y) = a_i*x + b_i*y + c_i

å‡ºåŠ›ã®è¼åº¦:
L_out(x,y) = L_clean(x,y) + [L_i(x,y) - L_ref(x,y)]
           = L_clean + (ç¾åœ¨ã®é™°å½± - å‚ç…§ã®é™°å½±)

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¯ãƒªãƒ¼ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®å…‰æºç’°å¢ƒã‚’é©ç”¨
```

---

##### 5. **é€†ãƒ¯ãƒ¼ãƒ—ï¼ˆå…ƒãƒ•ãƒ¬ãƒ¼ãƒ åº§æ¨™ç³»ã¸ã®å¤‰æ›ï¼‰**

```python
# é–¢æ•°: warp_norm_to_bbox()
# ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: OpenCV

# ã‚¹ãƒ†ãƒƒãƒ—1: quadã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
q = quad.reshape(4, 2)
x0 = int(np.floor(q[:, 0].min())) - 1
y0 = int(np.floor(q[:, 1].min())) - 1
x1 = int(np.ceil(q[:, 0].max())) + 1
y1 = int(np.ceil(q[:, 1].max())) + 1
bw = x1 - x0  # bboxå¹…
bh = y1 - y0  # bboxé«˜ã•

# ã‚¹ãƒ†ãƒƒãƒ—2: å¤‰æ›è¡Œåˆ—ã‚’è¨ˆç®—ï¼ˆæ­£è¦åŒ–ç©ºé–“ â†’ bboxåº§æ¨™ï¼‰
src_pts = np.array([
    [0, 0],
    [norm_w-1, 0],
    [norm_w-1, norm_h-1],
    [0, norm_h-1]
], dtype=np.float32)

dst_pts = q - np.array([x0, y0], dtype=np.float32)  # bboxå†…ã®ç›¸å¯¾åº§æ¨™

M_inv = cv2.getPerspectiveTransform(src_pts, dst_pts)

# ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‘ãƒƒãƒã¨ï¿½ï¿½ï¿½ã‚¹ã‚¯ã‚’é€†ãƒ¯ãƒ¼ãƒ—
warped_patch = cv2.warpPerspective(
    out_patch,                       # é™°å½±é©ç”¨å¾Œã®ãƒ‘ãƒƒãƒ
    M_inv,                           # é€†å¤‰æ›è¡Œåˆ—
    (bw, bh),                        # bbox ã‚µã‚¤ã‚º
    flags=cv2.INTER_LINEAR,
    borderMode=cv2.BORDER_REPLICATE
)

warped_mask = cv2.warpPerspective(
    mask_f,                          # ãƒ•ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¯ (norm_h, norm_w) float32
    M_inv,
    (bw, bh),
    flags=cv2.INTER_LINEAR,
    borderMode=cv2.BORDER_CONSTANT,
    borderValue=0.0
)
warped_mask = np.clip(warped_mask, 0.0, 1.0)[:, :, None]  # (bh, bw, 1)

# è¿”ã‚Šå€¤: (warped_patch, warped_mask, x0, y0)
```

**æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ**:
- ãƒ•ãƒ¬ãƒ¼ãƒ å…¨ä½“ã§ã¯ãªãbboxã®ã¿ã‚’ãƒ¯ãƒ¼ãƒ—ï¼ˆé«˜é€ŸåŒ–ï¼‰
- ãƒã‚¹ã‚¯ã‚‚åŒæ™‚ã«ãƒ¯ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ã§ã€å¢ƒç•Œã®æ­ªã¿ã«å¯¾å¿œ

---

##### 6. **ãƒ•ã‚§ã‚¶ãƒ¼ãƒ–ãƒ¬ãƒ³ãƒ‰ï¼ˆå…ƒãƒ•ãƒ¬ãƒ¼ãƒ ã¸ã®åˆæˆï¼‰**

```python
# é–¢æ•°: alpha_blend_roi() + ROIå¢ƒç•Œå‡¦ç†
# ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: NumPy, OpenCV

# ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¯ã®ç”Ÿæˆï¼ˆäº‹å‰å‡¦ç†ï¼‰
mask_f = feather_mask(inner_u8, dilate_px, feather_px)

# å†…éƒ¨å‡¦ç†:
m = inner_u8.copy()

# 1. ãƒã‚¹ã‚¯ã®è†¨å¼µï¼ˆdilateï¼‰
if dilate_px > 0:
    k = 2 * dilate_px + 1
    kernel = cv2.getStructuringElement(
        cv2.MORPH_ELLIPSE,  # æ¥•å††ã‚«ãƒ¼ãƒãƒ«
        (k, k)
    )
    m = cv2.dilate(m, kernel, iterations=1)

# 2. ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ã¼ã‹ã—ï¼ˆfeatherï¼‰
if feather_px > 0:
    k = 2 * feather_px + 1
    m = cv2.GaussianBlur(
        m,
        (k, k),           # ã‚«ãƒ¼ãƒãƒ«ã‚µã‚¤ã‚ºï¼ˆå¥‡æ•°ï¼‰
        sigmaX=0          # è‡ªå‹•è¨ˆç®—
    )

# 3. 0~1ã®ç¯„å›²ã«æ­£è¦åŒ–
mask_f = (m.astype(np.float32) / 255.0).clip(0.0, 1.0)

# ã‚¹ãƒ†ãƒƒãƒ—2: ROIå¢ƒç•Œå‡¦ç† + ã‚¢ãƒ«ãƒ•ã‚¡ãƒ–ãƒ¬ãƒ³ãƒ‰
H, W = frame.shape[:2]
bh, bw = warped_patch.shape[:2]

# bbox ãŒç”»é¢å¤–ã«ã¯ã¿å‡ºã‚‹å ´åˆã®å¢ƒç•Œå‡¦ç†
rx0 = max(0, x0)
ry0 = max(0, y0)
rx1 = min(W, x0 + bw)
ry1 = min(H, y0 + bh)

if rx0 < rx1 and ry0 < ry1:
    # æœ‰åŠ¹ãªé‡è¤‡é ˜åŸŸã®ã¿å‡¦ç†
    sx0 = rx0 - x0  # warped_patch å†…ã®é–‹å§‹ä½ç½®
    sy0 = ry0 - y0
    sx1 = sx0 + (rx1 - rx0)
    sy1 = sy0 + (ry1 - ry0)

    # ROI ã‚’æŠ½å‡º
    roi = frame[ry0:ry1, rx0:rx1]           # (rh, rw, 3) uint8
    src = warped_patch[sy0:sy1, sx0:sx1]   # (rh, rw, 3) uint8
    msk = warped_mask[sy0:sy1, sx0:sx1]    # (rh, rw, 1) float32

    # ã‚¢ãƒ«ãƒ•ã‚¡ãƒ–ãƒ¬ãƒ³ãƒ‰
    roi_f = roi.astype(np.float32)
    src_f = src.astype(np.float32)
    blended = roi_f * (1.0 - msk) + src_f * msk

    # å…ƒãƒ•ãƒ¬ãƒ¼ãƒ ã«æ›¸ãæˆ»ã—
    frame[ry0:ry1, rx0:rx1] = np.clip(blended, 0, 255).astype(np.uint8)
```

**ã‚¢ãƒ«ãƒ•ã‚¡ãƒ–ãƒ¬ãƒ³ãƒ‰ã®æ•°å¼**:
```
output = background * (1 - alpha) + foreground * alpha

alpha: 0~1 ã®é€æ˜åº¦
  0 = å®Œå…¨ã«èƒŒæ™¯
  1 = å®Œå…¨ã«å‰æ™¯
  0.5 = 50%ãšã¤æ··åˆ

ãƒ•ã‚§ã‚¶ãƒ¼ãƒã‚¹ã‚¯ã«ã‚ˆã‚Šã€å¢ƒç•ŒãŒæ»‘ã‚‰ã‹ã«ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```

**cv2.GaussianBlur() ã®å‹•ä½œ**:
- ã‚«ãƒ¼ãƒãƒ«ã‚µã‚¤ã‚º `(k, k)`: å¤§ãã„ã»ã©åºƒç¯„å›²ã‚’ã¼ã‹ã™
- `sigmaX=0`: ã‚«ãƒ¼ãƒãƒ«ã‚µã‚¤ã‚ºã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼ˆ`sigma â‰ˆ 0.3 * ((k-1)*0.5 - 1) + 0.8`ï¼‰
- åŠ¹æœ: ãƒã‚¹ã‚¯ã®ã‚¨ãƒƒã‚¸ãŒæ»‘ã‚‰ã‹ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚Šã€å¢ƒç•ŒãŒç›®ç«‹ãŸãªããªã‚‹

**cv2.getStructuringElement() ã®å½¹å‰²**:
- `MORPH_ELLIPSE`: æ¥•å††å½¢ã®ã‚«ãƒ¼ãƒãƒ«ï¼ˆå††å½¢ã«è¿‘ã„è†¨å¼µï¼‰
- å£ã®å½¢çŠ¶ãŒæ¥•å††ãªã®ã§ã€æ¥•å††ã‚«ãƒ¼ãƒãƒ«ãŒè‡ªç„¶
- é•·æ–¹å½¢ã‚«ãƒ¼ãƒãƒ« (`MORPH_RECT`) ã‚ˆã‚Šè§’ãŒä¸¸ãã€å¢ƒç•ŒãŒæ»‘ã‚‰ã‹

### ãƒã‚¹ã‚¯ç”Ÿæˆ

#### make_mouth_mask() - ã‚¢ãƒ‹ãƒ¡ç‰¹åŒ–ãƒã‚¹ã‚¯

```python
ç‰¹å¾´:
- æ¥•å††å½¢ã®åŸºæœ¬ãƒã‚¹ã‚¯
- center_y_offset_px: å£ã‚’å°‘ã—ä¸‹ã«ã‚·ãƒ•ãƒˆï¼ˆé¼»ã‹ã‚‰é›¢ã™ï¼‰
- top_clip_frac: ä¸Šéƒ¨ã‚’ã‚¯ãƒªãƒƒãƒ—ã—ã¦é¼»ã‚’ä¿è­·
  - 1.0 = ã»ã¼ã‚¯ãƒªãƒƒãƒ—ãªã—
  - 0.78 = ã‚ˆã‚Šå¼·ãã‚¯ãƒªãƒƒãƒ—
```

#### feather_mask() - ãƒ•ã‚§ã‚¶ãƒ¼å‡¦ç†

```python
æ‰‹é †:
1. dilate_px ã§ãƒã‚¹ã‚¯ã‚’è†¨å¼µï¼ˆæ¥•å††ã‚«ãƒ¼ãƒãƒ«ï¼‰
2. feather_px ã§ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ã¼ã‹ã—
3. 0~1ã®æµ®å‹•å°æ•°ç‚¹ãƒã‚¹ã‚¯ã‚’ç”Ÿæˆ
```

### PlaneFitter - é«˜é€Ÿãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°

ãƒªãƒ³ã‚°é ˜åŸŸã®ãƒ”ã‚¯ã‚»ãƒ«ä½ç½®ãŒå›ºå®šãªã®ã§ã€æœ€å°äºŒä¹—æ³•ã®ç–‘ä¼¼é€†è¡Œåˆ—ã¨ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰ã‚’äº‹å‰è¨ˆç®—:

```python
ã‚¯ãƒ©ã‚¹ã®åˆ©ç‚¹:
- åˆæœŸåŒ–æ™‚ã« pinv(A) ã¨ meshgrid ã‚’è¨ˆç®—
- ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã® fit() ã¯è¡Œåˆ—ç©ã®ã¿ï¼ˆé«˜é€Ÿï¼‰
- eval() ã‚‚ãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒªãƒƒãƒ‰ã‚’å†åˆ©ç”¨
```

ã“ã‚Œã«ã‚ˆã‚Šã€å‹•ç”»å‡¦ç†ãŒå¤§å¹…ã«é«˜é€ŸåŒ–ã•ã‚Œã¾ã™ã€‚

---

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¬ã‚¤ãƒ‰

### èª¿æ•´ã®åŸºæœ¬ãƒ•ãƒ­ãƒ¼

#### 1. ã¾ãšé™æ­¢ç”»ã§ãƒ†ã‚¹ãƒˆ (mouth_erase_tuner_gui.py)

```
1. å‹•ç”»ã‹ã‚‰ä»£è¡¨çš„ãª1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŠ½å‡º
2. GUIã§é–‹ã„ã¦ã€Œæ¤œå‡ºâ†’å£æ¶ˆã—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€
3. coverage ã‚’èª¿æ•´ï¼ˆ0.6 â†’ 0.7 â†’ 0.8ï¼‰
4. çµæœãŒè‰¯ã‘ã‚Œã°è¨­å®šã‚’JSONä¿å­˜
```

#### 2. å‹•ç”»ã§å‡¦ç† (erase_mouth_offline.py)

```bash
# GUIã§æ±ºã‚ãŸ coverage ã‚’ä½¿ç”¨
uv run python erase_mouth_offline.py \
  --video loop.mp4 \
  --track mouth_track_calibrated.npz \
  --out loop_mouthless.mp4 \
  --coverage 0.70 \
  --keep-audio
```

#### 3. æœ€é©åŒ–ãŒå¿…è¦ãªã‚‰ (auto_erase_mouth.py)

```bash
# è¤‡æ•°å€™è£œã‚’è©¦ã—ã¦è‡ªå‹•é¸æŠ
uv run python auto_erase_mouth.py \
  --video loop.mp4 \
  --track mouth_track_calibrated.npz \
  --out loop_mouthless.mp4 \
  --coverage "0.60,0.70,0.80" \
  --try-strict \
  --keep-audio
```

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

#### ğŸ”´ é¼»ã¾ã§æ¶ˆãˆã¦ã—ã¾ã†

**åŸå› **: ãƒã‚¹ã‚¯ãŒå¤§ãã™ãã‚‹ã€ã¾ãŸã¯ä¸Šéƒ¨ã‚¯ãƒªãƒƒãƒ—ãŒä¸è¶³

**å¯¾å‡¦æ³•**:
- `coverage` ã‚’ä¸‹ã’ã‚‹ï¼ˆ0.8 â†’ 0.6ï¼‰
- `top_clip_frac` ã‚’ä¸‹ã’ã‚‹ï¼ˆ0.82 â†’ 0.75ï¼‰
- `center_y_off_frac` ã‚’ä¸Šã’ã‚‹ï¼ˆ0.05 â†’ 0.08ï¼‰å£ã‚’ä¸‹ã«ã‚·ãƒ•ãƒˆ

#### ğŸ”´ å£ã®ç«¯ãŒæ®‹ã‚‹

**åŸå› **: ãƒã‚¹ã‚¯ãŒå°ã•ã™ãã‚‹

**å¯¾å‡¦æ³•**:
- `coverage` ã‚’ä¸Šã’ã‚‹ï¼ˆ0.6 â†’ 0.8ï¼‰
- `mask_scale_x` ã‚’ä¸Šã’ã‚‹ï¼ˆ0.62 â†’ 0.70ï¼‰
- `pad` ã‚’ä¸Šã’ã‚‹ï¼ˆ2.1 â†’ 2.5ï¼‰

#### ğŸ”´ å¢ƒç•ŒãŒç›®ç«‹ã¤

**åŸå› **: ãƒ•ã‚§ã‚¶ãƒ¼ãŒä¸è¶³

**å¯¾å‡¦æ³•**:
- `feather_px` ã‚’ä¸Šã’ã‚‹ï¼ˆ20 â†’ 30ï¼‰
- `dilate_px` ã‚’ä¸Šã’ã‚‹ï¼ˆ10 â†’ 15ï¼‰

#### ğŸ”´ è‰²ãŒå‘¨å›²ã¨åˆã‚ãªã„

**åŸå› **: ãƒªãƒ³ã‚°é ˜åŸŸãŒä¸é©åˆ‡ã€ã¾ãŸã¯é™°å½±ãƒãƒƒãƒãƒ³ã‚°ã®å•é¡Œ

**å¯¾å‡¦æ³•**:
- `ring_px` ã‚’èª¿æ•´ï¼ˆ18 â†’ 24ï¼‰
- `--shading plane` ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- GUIã®ã€Œringã‹ã‚‰è‰²/é™°å½±ã‚’åˆã‚ã›ã‚‹ã€ã‚’ON

#### ğŸ”´ ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã§ã¡ã‚‰ã¤ãï¼ˆå‹•ç”»ã®ã¿ï¼‰

**åŸå› **: ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å“è³ªãŒä½ã„ã€ã¾ãŸã¯å‚ç…§ãƒ•ãƒ¬ãƒ¼ãƒ ãŒä¸é©åˆ‡

**å¯¾å‡¦æ³•**:
- ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ã‚„ã‚Šç›´ã™ï¼ˆface_track_anime_detector.pyï¼‰
- `--ref-mode smart` ã‚’ä½¿ç”¨ï¼ˆauto_erase_mouth.pyï¼‰
- `--valid-policy hold` ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

#### ğŸ”´ ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒˆã®è³ªãŒæ‚ªã„

**åŸå› **: inpaint_radius ãŒå°ã•ã™ãã‚‹ã€ã¾ãŸã¯å¤§ãã™ãã‚‹

**å¯¾å‡¦æ³•**:
- `inpaint_radius` ã‚’èª¿æ•´ï¼ˆ5.0 â†’ 7.0ï¼‰
- å°ã•ã„: å¡—ã‚ŠãŒç²—ã„
- å¤§ãã„: å‘¨å›²ã®æ¨¡æ§˜ã‚’å¼•ã£å¼µã‚Šã™ãã‚‹

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç›¸äº’ä½œç”¨

#### coverage ã§é€£å‹•ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

`--coverage 0.70` ã‚’æŒ‡å®šã™ã‚‹ã¨:

```
mask_scale_x = 0.50 + 0.18 * 0.70 = 0.626
mask_scale_y = 0.44 + 0.14 * 0.70 = 0.538
ring_px      = 16 + 10 * 0.70 = 23
dilate_px    = 8 + 8 * 0.70 = 13
feather_px   = 18 + 10 * 0.70 = 25
inpaint_radius = 4.0 + 4.0 * 0.70 = 6.8
top_clip_frac = 0.84 - 0.06 * 0.70 = 0.798
center_y_off = norm_h * (0.05 + 0.01 * 0.70)
```

ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒé€£å‹•ã—ã¦èª¿æ•´ã•ã‚Œã¾ã™ã€‚

#### quad_mode ã¨ pad ã®é–¢ä¿‚

- `quad_mode=bbox`: `pad`ãŒå¤§ããå½±éŸ¿ï¼ˆé¡”ã‚µã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ï¼‰
- `quad_mode=mouth`: `pad`ãŒå°ã•ãå½±éŸ¿ï¼ˆå£ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ™ãƒ¼ã‚¹ï¼‰
- `quad_mode=hybrid`: ä¸¡æ–¹ã®ä¸­é–“ï¼ˆæ¨å¥¨ï¼‰

---

## ã¾ã¨ã‚

### æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‹•ç”»ã‹ã‚‰ä»£è¡¨ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. mouth_erase_tuner_gui.py â”‚ â† é™æ­¢ç”»ã§ç´ æ—©ããƒ†ã‚¹ãƒˆ
â”‚    ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ãƒ»JSONä¿å­˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. erase_mouth_offline.py   â”‚ â† å‹•ç”»ã§é«˜å“è³ªå‡¦ç†
â”‚    æ±ºå®šã—ãŸè¨­å®šã§å‡¦ç†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. çµæœãŒä¸æº€ãªã‚‰           â”‚
â”‚    auto_erase_mouth.py      â”‚ â† è‡ªå‹•æœ€é©åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ„ãƒ¼ãƒ«é¸æŠã‚¬ã‚¤ãƒ‰

| çŠ¶æ³ | ä½¿ç”¨ãƒ„ãƒ¼ãƒ« | ç†ç”± |
|-----|----------|------|
| åˆã‚ã¦ä½¿ã† | mouth_erase_tuner_gui.py | GUIã§è©¦è¡ŒéŒ¯èª¤ã—ã‚„ã™ã„ |
| è¨­å®šãŒæ±ºã¾ã£ã¦ã„ã‚‹ | erase_mouth_offline.py | é«˜é€Ÿãƒ»é«˜å“è³ª |
| æœ€é©è¨­å®šãŒä¸æ˜ | auto_erase_mouth.py | è‡ªå‹•ã§æœ€è‰¯ã‚’é¸æŠ |
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸã„ | mouth_erase_tuner_gui.py | JSONä¿å­˜æ©Ÿèƒ½ã‚ã‚Š |
| ãƒãƒƒãƒå‡¦ç† | auto_erase_mouth.py | ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã—ã‚„ã™ã„ |

---

## å‚è€ƒæƒ…å ±

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [face_track_anime_detector.py](../face_track_anime_detector.py): ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
- [calibrate_mouth_track.py](../calibrate_mouth_track.py): ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•èª¿æ•´
- [mouth_sprite_extractor_gui.py](../mouth_sprite_extractor_gui.py): å£ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã®æŠ½å‡º

### ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **å¿…é ˆ**: opencv-python, numpy
- **GUI**: pillow, tkinter
- **æ¤œå‡º**: anime-face-detector (mmdet, mmpose)
- **ã‚ªãƒ—ã‚·ãƒ§ãƒ³**: ffmpeg (éŸ³å£°ä¿æŒç”¨)

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆæ—¥**: 2026-01-20
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: MotionPNGTuber æœ€æ–°ç‰ˆ
